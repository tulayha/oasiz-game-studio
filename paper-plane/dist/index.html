<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, minimal-ui">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Paper Plane Asteroid Survivor</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&family=Patrick+Hand&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            font-family: 'Patrick Hand', 'Caveat', cursive;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Game Container - constrained on desktop */

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 480px;
            max-height: 850px;
            background: #f5f5dc;
            overflow: hidden;
            border-radius: 24px;
            border: 6px solid #2d2d2d;
            box-shadow: 0 0 0 4px #4a4a4a, 0 25px 60px rgba(0, 0, 0, 0.5);
        }

        /* Mobile: fullscreen, no border */

        @media (pointer: coarse) {
            #game-container {
                max-width: none;
                max-height: none;
                border: none;
                border-radius: 0;
                box-shadow: none;
            }
            html, body {
                background: #f5f5dc;
            }
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }

        /* ============= OVERLAYS ============= */

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            pointer-events: none;
            background: rgba(245, 245, 220, 0.85);
        }

        .overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .overlay:not(.hidden) {
            pointer-events: auto;
        }

        .content {
            text-align: center;
            padding: 30px;
            max-width: 90%;
        }

        /* ============= BUTTONS ============= */

        .btn {
            background: #fff;
            color: #2d2d2d;
            border: 3px solid #2d2d2d;
            padding: 14px 40px;
            font-family: 'Patrick Hand', cursive;
            font-size: 1.4rem;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 4px 4px 0 #2d2d2d;
            transition: all 0.1s ease;
            position: relative;
        }

        .btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #2d2d2d;
        }

        .btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #2d2d2d;
        }

        .btn-secondary {
            background: transparent;
            border: 2px dashed #6d6d6d;
            color: #6d6d6d;
            box-shadow: none;
        }

        .btn-secondary:hover {
            background: rgba(0,0,0,0.05);
            box-shadow: none;
            transform: none;
        }

        /* ============= DAMAGE OVERLAY ============= */

        #damageOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at center, transparent 40%, rgba(255, 50, 50, 0.3) 100%);
            pointer-events: none;
            opacity: 0;
            z-index: 100;
            transition: opacity 0.15s ease-out;
        }

        #damageOverlay.active {
            opacity: 1;
            animation: damageFlash 0.3s ease-out;
        }

        @keyframes damageFlash {
            0% { opacity: 0.8; background: radial-gradient(ellipse at center, rgba(255, 100, 100, 0.2) 0%, rgba(255, 50, 50, 0.5) 100%); }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* ============= BOSS ANNOUNCEMENT ============= */

        #bossAnnouncement {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 0;
            z-index: 200;
            background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.6) 100%);
            transition: opacity 0.3s ease;
        }

        #bossAnnouncement.active {
            opacity: 1;
            animation: bossShake 0.5s ease-out;
        }

        .boss-text {
            font-family: 'Architects Daughter', cursive;
            font-size: 3.5rem;
            font-weight: bold;
            color: #ff4444;
            text-shadow: 
                3px 3px 0 #000,
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                0 0 20px rgba(255, 68, 68, 0.8);
            letter-spacing: 4px;
            animation: bossPulse 0.3s ease-in-out infinite alternate;
        }

        @keyframes bossShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }

        @keyframes bossPulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        @media (pointer: coarse) {
            .boss-text {
                font-size: 2.5rem;
            }
        }

        /* ============= HUD ============= */

        #hud {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 45px 75px 10px 75px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 5;
            pointer-events: none;
        }

        @media (pointer: coarse) {
            #hud {
                padding-top: 120px;
            }
        }

        #uiLayer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 20;
            pointer-events: none;
        }

        .hidden {
            display: none !important;
        }

        /* Ability Slots (Stackable) */

        #abilitySlots {
            position: absolute;
            bottom: 45px;
            right: 20px;
            display: flex;
            flex-direction: column-reverse; /* Stack upwards from bottom */
            gap: 15px;
            z-index: 1;
            pointer-events: none;
        }

        @media (pointer: coarse) {
            #abilitySlots {
                bottom: 120px;
            }
        }

        .ability-slot {
            width: 64px;
            height: 64px;
            background: #fff;
            border: 3px solid #2d2d2d;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 4px 4px 0 #2d2d2d;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            position: relative;
            /* No animation - causes issues when DOM is recreated */
        }

        .ability-slot:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #2d2d2d;
        }

        .ability-slot .icon {
            font-size: 1.5rem;
            line-height: 1;
            color: #2d2d2d;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ability-slot .icon .ability-svg {
            width: 28px;
            height: 28px;
        }

        .ability-slot .label {
            font-size: 0.6rem;
            font-weight: bold;
            text-transform: uppercase;
            text-align: center;
            max-width: 100%;
            overflow: hidden;
            white-space: nowrap;
        }

        .ability-slot.active {
            background: #ffffee;
            border-color: #ff4444;
            animation: pulse-active 1s infinite alternate;
        }

        @keyframes pulse-active {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        .ability-slot.cooldown {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(1);
        }

        .ability-slot .timer {
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            background: #2d2d2d;
            color: white;
            font-size: 0.6rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .ability-indicator {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4444;
            color: white;
            border: 2px solid #2d2d2d;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .ability-svg {
            width: 24px;
            height: 24px;
            color: inherit;
        }

        .ability-card-icon .ability-svg {
            width: 48px;
            height: 48px;
            margin-bottom: 8px;
        }

        .hud-left, .hud-right {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .hud-center {
            text-align: center;
        }

        .hud-lives {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 8px;
        }

        .life-heart {
            font-size: 1.4rem;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .life-heart.filled {
            color: #ff4d4d;
            text-shadow: 0 0 6px rgba(255, 77, 77, 0.5);
        }

        .life-heart.empty {
            color: #ccc;
            opacity: 0.4;
        }

        @media (pointer: coarse) {
            .life-heart {
                font-size: 1.6rem;
            }
        }

        .hud-label {
            font-size: 0.9rem;
            color: #6d6d6d;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .hud-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2d2d2d;
            font-family: 'Caveat', cursive;
        }

        .hud-small {
            font-size: 0.85rem;
            color: #888;
        }

        /* Progress Bar */

        .progress-bar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-width: 120px;
        }

        .progress-bar-bg {
            width: 100%;
            height: 12px;
            background: #e8e4dc;
            border: 2px solid #4a4a4a;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.15);
        }

        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #7cb342, #8bc34a);
            border-radius: 4px;
            transition: width 0.2s ease-out;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #4a4a4a;
            font-family: 'Caveat', cursive;
            font-weight: 600;
        }

        @media (pointer: coarse) {
            .progress-bar-container {
                min-width: 100px;
            }
            .progress-bar-bg {
                height: 10px;
            }
        }

        /* Pause Button */

        #pauseBtn {
            position: absolute;
            top: 45px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.8);
            border: 2px solid #2d2d2d;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 15;
            pointer-events: auto;
        }

        @media (pointer: coarse) {
            #pauseBtn {
                top: 120px;
            }
        }

        #pauseBtn svg {
            width: 20px;
            height: 20px;
            fill: #2d2d2d;
        }

        /* Settings Button */

        #settingsBtn {
            position: absolute;
            top: 45px;
            left: 20px;
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.8);
            border: 2px solid #2d2d2d;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 15;
            pointer-events: auto;
        }

        @media (pointer: coarse) {
            #settingsBtn {
                top: 120px;
            }
        }

        #settingsBtn svg {
            width: 20px;
            height: 20px;
            fill: #2d2d2d;
        }

        /* ============= UPGRADE DOTS ============= */

        .upgrade-indicators {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 30px;
            z-index: 5;
            pointer-events: none;
        }

        .upgrade-dots {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .upgrade-dots .label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dots-row {
            display: flex;
            gap: 4px;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid #2d2d2d;
            background: transparent;
            transition: background 0.3s ease;
        }

        .dot.filled {
            background: #2d2d2d;
        }

        /* ============= START SCREEN ============= */

        #startScreen .title {
            font-family: 'Caveat', cursive;
            font-size: 3rem;
            font-weight: 700;
            color: #2d2d2d;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        #startScreen .subtitle {
            font-size: 1.2rem;
            color: #6d6d6d;
            margin-bottom: 20px;
        }

        /* Demo Animation Container */

        .demo-container {
            width: 280px;
            height: 200px;
            background: rgba(255,255,255,0.6);
            border: 3px solid #2d2d2d;
            border-radius: 16px;
            margin: 0 auto 25px auto;
            box-shadow: 4px 4px 0 #2d2d2d;
            overflow: hidden;
            position: relative;
        }

        #demoCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Start Screen Buttons */

        .start-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        .btn-planes {
            background: transparent;
            border: 2px dashed #6d6d6d;
            color: #6d6d6d;
            padding: 10px 25px;
            font-size: 1.1rem;
        }

        .btn-planes:hover {
            background: rgba(0,0,0,0.05);
            box-shadow: none;
            transform: none;
        }

        .selected-plane-label {
            font-size: 0.9rem;
            color: #888;
            margin-top: 5px;
        }

        .selected-plane-name {
            font-weight: 600;
            color: #2d2d2d;
        }

        /* ============= GALLERY OVERLAY ============= */

        #galleryScreen {
            background: rgba(245, 245, 220, 0.95);
        }

        #galleryScreen .content {
            max-width: 900px;
        }

        .plane-select-title {
            font-family: 'Caveat', cursive;
            font-size: 2.5rem;
            color: #2d2d2d;
            margin-bottom: 25px;
        }

        .plane-selection {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .plane-card {
            background: #fff;
            border: 3px solid #2d2d2d;
            border-radius: 12px;
            padding: 15px 12px;
            width: 110px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 3px 3px 0 #2d2d2d;
        }

        .plane-card:hover {
            transform: translateY(-3px);
            box-shadow: 5px 5px 0 #2d2d2d;
        }

        .plane-card.selected {
            background: #fffde7;
            border-color: #f9a825;
            box-shadow: 3px 3px 0 #f9a825;
        }

        .plane-icon {
            font-size: 1.4rem;
            margin: 0 auto 8px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #d0d0c0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2d2d2d;
        }

        .gallery-content {
            max-height: 80vh;
            overflow-y: auto;
        }

        .gallery-section {
            margin-bottom: 28px;
            text-align: left;
        }

        .gallery-title {
            font-size: 1.3rem;
            color: #2d2d2d;
            margin-bottom: 14px;
            border-bottom: 2px solid #d4d4c4;
            padding-bottom: 6px;
        }

        .boss-gallery {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .boss-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 500px;
        }

        .boss-card {
            background: #fff;
            border: 3px solid #2d2d2d;
            padding: 16px;
            border-radius: 15px 50px 15px 45px / 45px 15px 45px 15px; /* Hand-drawn look */
            box-shadow: 4px 4px 0 #2d2d2d;
            text-align: left;
        }

        .boss-name {
            font-size: 1.3rem;
            margin-bottom: 6px;
            color: #2d2d2d;
        }

        .boss-desc {
            color: #555;
            font-size: 0.95rem;
        }

        .modifier-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .modifier-chip {
            background: #fff;
            border: 1px solid #d0d0c0;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
            color: #2d2d2d;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .chip-svg {
            width: 14px;
            height: 14px;
            color: #2d2d2d;
        }

        /* ============= UPGRADE CARDS (NEW DESIGN) ============= */

        .upgrade-subtitle {
            font-family: 'Caveat', cursive;
            font-size: 1.3rem;
            color: #6d6d6d;
            margin-bottom: 24px;
        }

        .upgrade-cards-container {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            max-width: 600px;
            margin: 0 auto;
        }

        .upgrade-card {
            background: #fff;
            border: 3px solid #2d2d2d;
            border-radius: 16px;
            padding: 20px 16px;
            width: 160px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 5px 5px 0 #2d2d2d;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .upgrade-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                -45deg,
                transparent,
                transparent 8px,
                rgba(45, 45, 45, 0.02) 8px,
                rgba(45, 45, 45, 0.02) 16px
            );
            pointer-events: none;
        }

        .upgrade-card:hover {
            transform: translateY(-8px) rotate(-1deg);
            box-shadow: 8px 12px 0 #2d2d2d;
        }

        .upgrade-card:active {
            transform: translateY(-2px);
            box-shadow: 3px 3px 0 #2d2d2d;
        }

        .upgrade-card.maxed {
            opacity: 0.4;
            cursor: not-allowed;
            border-style: dashed;
        }

        .upgrade-card.maxed:hover {
            transform: none;
            box-shadow: 5px 5px 0 #2d2d2d;
        }

        .upgrade-card-icon {
            width: 56px;
            height: 56px;
            margin: 0 auto 12px;
            border: 3px solid #2d2d2d;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5dc;
        }

        .upgrade-svg {
            width: 32px;
            height: 32px;
            color: #2d2d2d;
        }

        .upgrade-card-title {
            font-family: 'Caveat', cursive;
            font-size: 1.4rem;
            font-weight: 700;
            color: #2d2d2d;
            margin-bottom: 10px;
        }

        .upgrade-card-level {
            margin-bottom: 14px;
        }

        .level-dots {
            display: flex;
            gap: 6px;
            justify-content: center;
        }

        .level-dots .dot {
            width: 12px;
            height: 12px;
            border: 2px solid #2d2d2d;
            border-radius: 50%;
            background: transparent;
            transition: all 0.2s ease;
        }

        .level-dots .dot.filled {
            background: #2d2d2d;
        }

        .upgrade-card-next {
            background: #f5f5dc;
            border: 2px dashed #b0b0a0;
            border-radius: 8px;
            padding: 10px 8px;
            margin-top: auto;
        }

        .next-label {
            display: block;
            font-size: 0.65rem;
            letter-spacing: 2px;
            color: #888;
            margin-bottom: 4px;
        }

        .next-name {
            display: block;
            font-family: 'Caveat', cursive;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d2d2d;
            margin-bottom: 2px;
        }

        .next-bonus {
            display: block;
            font-size: 0.8rem;
            color: #4a4a4a;
        }

        .upgrade-card.maxed .upgrade-card-next {
            border-style: solid;
        }

        .upgrade-card.maxed .next-label {
            display: none;
        }

        .upgrade-card.maxed .next-name {
            font-size: 1rem;
        }

        .upgrade-card.maxed .next-name::before {
            content: 'âœ“ ';
        }

        .upgrade-card.maxed .next-bonus {
            display: none;
        }

        /* ============= ABILITY SELECTION SCREEN ============= */

        #abilityScreen {
            background: rgba(245, 245, 220, 0.97);
        }

        .ability-title {
            font-family: 'Caveat', cursive;
            font-size: 2.8rem;
            color: #2d2d2d;
            margin-bottom: 4px;
            letter-spacing: 2px;
        }

        .ability-subtitle {
            font-family: 'Caveat', cursive;
            font-size: 1.3rem;
            color: #6d6d6d;
            margin-bottom: 28px;
        }

        .ability-cards-container {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            max-width: 600px;
            margin: 0 auto;
        }

        .ability-card {
            background: #fff;
            border: 3px solid #2d2d2d;
            border-radius: 16px;
            padding: 20px 16px;
            width: 160px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 5px 5px 0 #2d2d2d;
            text-align: center;
            position: relative;
        }

        .ability-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: repeating-linear-gradient(
                90deg,
                #2d2d2d,
                #2d2d2d 4px,
                transparent 4px,
                transparent 8px
            );
            border-radius: 12px 12px 0 0;
        }

        .ability-card:hover {
            transform: translateY(-8px) rotate(1deg);
            box-shadow: 8px 12px 0 #2d2d2d;
        }

        .ability-card:active {
            transform: translateY(-2px);
            box-shadow: 3px 3px 0 #2d2d2d;
        }

        .ability-card-icon {
            width: 64px;
            height: 64px;
            margin: 8px auto 12px;
            border: 3px solid #2d2d2d;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5dc;
        }

        .ability-card-emoji {
            font-size: 2rem;
        }

        .ability-card-title {
            font-family: 'Caveat', cursive;
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d2d2d;
            margin-bottom: 8px;
        }

        .ability-card-desc {
            font-size: 0.85rem;
            color: #5d5d5d;
            line-height: 1.3;
            margin-bottom: 12px;
            min-height: 2.6em;
        }

        .ability-card-charges {
            display: inline-block;
            font-size: 0.7rem;
            letter-spacing: 2px;
            color: #fff;
            background: #2d2d2d;
            padding: 4px 12px;
            border-radius: 999px;
            font-weight: 600;
        }

        /* Tier-based ability card borders */

        .ability-card[data-tier="2"] {
            border-width: 4px;
        }

        .ability-card[data-tier="3"] {
            border-width: 4px;
            box-shadow: 6px 6px 0 #2d2d2d;
        }

        .ability-card[data-tier="4"] {
            border-width: 5px;
            box-shadow: 7px 7px 0 #2d2d2d;
        }

        .ability-card[data-tier="5"] {
            border-width: 5px;
            box-shadow: 8px 8px 0 #2d2d2d;
        }

        .ability-card[data-tier="6"] {
            border-width: 6px;
            box-shadow: 10px 10px 0 #2d2d2d;
        }

        .ability-card[data-tier="6"] .ability-card-icon {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* ============= ITEM INVENTORY ============= */

        .item-inventory {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            padding: 0 12px;
            z-index: 6;
            pointer-events: none;
        }

        .item-inventory.hidden {
            display: none;
        }

        .item-chip {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #d0d0c0;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            color: #2d2d2d;
            white-space: nowrap;
        }

        .item-chip.cursed {
            background: rgba(80, 30, 30, 0.85);
            border-color: #8b3a3a;
            color: #ffd1d1;
        }

        .hud-shield {
            font-size: 0.8rem;
            color: #4b6cb7;
            margin-bottom: 4px;
            min-height: 1em;
        }

        .plane-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2d2d2d;
            margin-bottom: 5px;
        }

        .plane-quirk {
            font-size: 0.7rem;
            color: #888;
            line-height: 1.3;
        }

        /* ============= UPGRADE SCREEN ============= */

        #upgradeScreen {
            background: rgba(245, 245, 220, 0.97);
        }

        .upgrade-title {
            font-family: 'Caveat', cursive;
            font-size: 2.8rem;
            color: #2d2d2d;
            margin-bottom: 4px;
            letter-spacing: 2px;
        }

        .upgrade-tier {
            font-size: 0.7rem;
            color: #6d6d6d;
            margin-bottom: 8px;
        }

        .upgrade-name {
            font-size: 1rem;
            font-weight: 600;
            color: #2d2d2d;
            margin-bottom: 6px;
        }

        .upgrade-desc {
            font-size: 0.7rem;
            color: #666;
            line-height: 1.4;
        }

        /* ============= PAUSE SCREEN ============= */

        #pauseScreen {
            background: rgba(0, 0, 0, 0.4);
        }

        #pauseScreen .content {
            background: #fff;
            border: 4px solid #2d2d2d;
            border-radius: 16px;
            box-shadow: 6px 6px 0 #2d2d2d;
            padding: 40px;
        }

        .pause-title {
            font-family: 'Caveat', cursive;
            font-size: 2.5rem;
            color: #2d2d2d;
            margin-bottom: 30px;
        }

        .pause-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* ============= GAME OVER SCREEN ============= */

        #gameOverScreen .game-over-title {
            font-family: 'Caveat', cursive;
            font-size: 3rem;
            color: #2d2d2d;
            margin-bottom: 30px;
        }

        .final-stats {
            background: #fff;
            border: 3px solid #2d2d2d;
            border-radius: 12px;
            padding: 25px 40px;
            margin-bottom: 30px;
            box-shadow: 4px 4px 0 #2d2d2d;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #ccc;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-size: 1rem;
            color: #6d6d6d;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2d2d2d;
            font-family: 'Caveat', cursive;
        }

        .upgrade-summary {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #ccc;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
        }

        .summary-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d2d2d;
        }

        .game-over-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* ============= SETTINGS MODAL ============= */

        #settingsModal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 4px solid #2d2d2d;
            border-radius: 16px;
            padding: 30px 40px;
            z-index: 100;
            box-shadow: 6px 6px 0 #2d2d2d;
            min-width: 280px;
        }

        #settingsModal.hidden {
            display: none;
        }

        .settings-title {
            font-family: 'Caveat', cursive;
            font-size: 2rem;
            color: #2d2d2d;
            margin-bottom: 25px;
            text-align: center;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed #ddd;
        }

        .settings-row:last-of-type {
            border-bottom: none;
        }

        .settings-label {
            font-size: 1.1rem;
            color: #2d2d2d;
        }

        .toggle {
            width: 50px;
            height: 28px;
            background: #ddd;
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
            border: 2px solid #2d2d2d;
        }

        .toggle.active {
            background: #8bc34a;
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
            border: 2px solid #2d2d2d;
        }

        .toggle.active::after {
            transform: translateX(22px);
        }

        .settings-close {
            margin-top: 25px;
            width: 100%;
        }

        /* ============= RESPONSIVE ============= */

        @media (max-width: 500px) {
            .plane-selection {
                gap: 10px;
            }
            .plane-card {
                width: 100px;
                padding: 15px 10px;
            }
            .plane-icon {
                font-size: 2rem;
            }
            .upgrade-card {
                width: 110px;
                padding: 15px 10px;
            }
            #startScreen .title {
                font-size: 2.2rem;
            }
        }
    </style>
  <script type="module" crossorigin>(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();const l={PLAYER_Y_RATIO:.85,PLAYER_WIDTH:50,PLAYER_HEIGHT:60,PLAYER_SPEED:8,PLAYER_FIRE_RATE:333,BULLET_SPEED:12,BULLET_POOL_SIZE:200,ASTEROID_POOL_SIZE:100,ASTEROID_SIZES:{large:{radius:58,health:4,speed:2,coins:15},medium:{radius:42,health:2,speed:2.8,coins:8},small:{radius:28,health:1,speed:3.5,coins:3}},SPAWN_INTERVAL_START:1800,SPAWN_INTERVAL_MIN:350,BOSS_HEALTH:60,BOSS_RADIUS:120,BOSS_ASTEROID_HEALTH:10,BOSS_Y_POSITION:180,DRONE_ORBIT_RADIUS:60,PARTICLE_POOL_SIZE:500,SPEED_INCREASE_INTERVAL:6e4,HEALTH_INCREASE_INTERVAL:6e4,BACKGROUND_SCROLL_SPEED:50,GRID_SIZE:40,PAPER_BG:"#f5f5dc",GRID_LINE:"#d4d4c4",PENCIL_DARK:"#2d2d2d",PENCIL_MEDIUM:"#4a4a4a",PENCIL_LIGHT:"#6d6d6d",COIN_GOLD:"#ffd700",FONT_FAMILY:"Caveat, cursive"},A=[[{id:"shield_1",name:"Paper Shield",description:"Crumpled paper protection! Become invincible for 5 seconds.",icon:"shield",charges:1,tier:1,duration:5},{id:"blast_1",name:"Eraser Blast",description:"Rub it out! Destroy all asteroids on screen.",icon:"blast",charges:1,tier:1},{id:"turbo_1",name:"Ink Overdrive",description:"Fresh ink! Double fire rate and speed for 8 seconds.",icon:"turbo",charges:1,tier:1,duration:8,power:2}],[{id:"shield_2",name:"Reinforced Paper",description:"Double-layered! Invincible for 8 seconds.",icon:"shield",charges:2,tier:2,duration:8},{id:"blast_2",name:"Eraser Storm",description:"Powerful eraser! Destroy all + deal 20 boss damage.",icon:"blast",charges:1,tier:2,power:20},{id:"turbo_2",name:"Pencil Fury",description:"Sharpened! Triple fire rate and speed for 10 seconds.",icon:"turbo",charges:1,tier:2,duration:10,power:3}],[{id:"shield_3",name:"Steel Origami",description:"Metal-folded! Invincible for 10 seconds + reflect damage.",icon:"shield",charges:2,tier:3,duration:10},{id:"blast_3",name:"Nuclear Eraser",description:"Massive blast! Destroy everything + 40 boss damage.",icon:"blast",charges:1,tier:3,power:40},{id:"turbo_3",name:"Graphite Rush",description:"Pure graphite! 4x fire rate + extra bullets for 12 seconds.",icon:"turbo",charges:1,tier:3,duration:12,power:4}],[{id:"shield_4",name:"Diamond Fold",description:"Crystallized! 12 seconds invincibility + auto-fire.",icon:"shield",charges:2,tier:4,duration:12},{id:"blast_4",name:"Black Hole",description:"Gravitational pull! Pulls in and destroys all + 60 boss damage.",icon:"blast",charges:1,tier:4,power:60},{id:"turbo_4",name:"Ink Explosion",description:"Explosive ink! Bullets explode on impact for 15 seconds.",icon:"turbo",charges:1,tier:4,duration:15,power:5}],[{id:"shield_5",name:"Origami Fortress",description:"Impenetrable! 15 seconds invincibility + damage aura.",icon:"shield",charges:3,tier:5,duration:15},{id:"blast_5",name:"Eraser Apocalypse",description:"Total annihilation! Screen-wide destruction + 80 boss damage.",icon:"blast",charges:1,tier:5,power:80},{id:"turbo_5",name:"Rainbow Ink",description:"Legendary ink! All stats doubled for 20 seconds.",icon:"turbo",charges:1,tier:5,duration:20,power:6}],[{id:"shield_6",name:"Paper God",description:"Divine protection! 20 seconds invincibility + triple damage.",icon:"shield",charges:3,tier:6,duration:20},{id:"blast_6",name:"Reality Eraser",description:"Erase reality! Freeze time + destroy everything + 100 boss damage.",icon:"blast",charges:1,tier:6,power:100},{id:"turbo_6",name:"Eternal Ink",description:"Infinite power! Permanent +25% stats + 25s massive boost.",icon:"turbo",charges:1,tier:6,duration:25,power:8}]],g={eraser:{name:"The Eraser",subtitle:"Pink Menace",healthMult:1,waveInterval:4e3,attacksPerWave:3,attackDelay:400,movePattern:"sway",color:"#f5b5c8",accentColor:"#d4869c"},paperweight:{name:"Paperweight",subtitle:"Heavy Hitter",healthMult:1.4,waveInterval:5e3,attacksPerWave:5,attackDelay:200,movePattern:"static",color:"#8b8b8b",accentColor:"#5a5a5a"},inkblot:{name:"Ink Blot",subtitle:"Chaotic Stain",healthMult:1,waveInterval:5500,attacksPerWave:2,attackDelay:600,movePattern:"chase",color:"#2a2a4a",accentColor:"#1a1a2a"},rubberband:{name:"Rubber Band Ball",subtitle:"Bouncy Nightmare",healthMult:1.2,waveInterval:4500,attacksPerWave:4,attackDelay:300,movePattern:"bounce",color:"#c4a574",accentColor:"#8b6914"},stapler:{name:"The Stapler",subtitle:"Rapid Fire",healthMult:1.3,waveInterval:3500,attacksPerWave:8,attackDelay:120,movePattern:"zigzag",color:"#4a4a4a",accentColor:"#ff4444"},scissors:{name:"Scissors",subtitle:"Final Cut",healthMult:1.8,waveInterval:4e3,attacksPerWave:3,attackDelay:500,movePattern:"circle",color:"#c0c0c0",accentColor:"#ff6600"}},I=["eraser","paperweight","inkblot","rubberband","stapler","scissors"];function p(m,e,t){return m+(e-m)*t}function v(m,e,t){return Math.max(e,Math.min(t,m))}function T(m,e){return m+Math.random()*(e-m)}function b(m,e,t,s){return Math.sqrt((t-m)**2+(s-e)**2)}function E(m){return 1+2.70158*Math.pow(m-1,3)+1.70158*Math.pow(m-1,2)}class k{listeners=new Map;on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){const s=this.listeners.get(e);if(s){const i=s.indexOf(t);i!==-1&&s.splice(i,1)}}emit(e,t){const s=this.listeners.get(e);s&&s.forEach(i=>i(t))}}class M{pool=[];createFn;resetFn;constructor(e,t,s=0){this.createFn=e,this.resetFn=t;for(let i=0;i<s;i++)this.pool.push(e())}acquire(){return this.pool.length>0?this.pool.pop():this.createFn()}release(e){this.resetFn(e),this.pool.push(e)}reset(){this.pool=[]}}class w{ctx=null;masterGain=null;musicGain=null;sfxGain=null;initialized=!1;bgMusic=null;bgMusicLoaded=!1;settings;constructor(e){this.settings=e,console.log("[AudioManager] Created")}init(){if(!this.initialized)try{this.ctx=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.ctx.createGain(),this.masterGain.gain.value=.5,this.masterGain.connect(this.ctx.destination),this.musicGain=this.ctx.createGain(),this.musicGain.gain.value=.3,this.musicGain.connect(this.masterGain),this.sfxGain=this.ctx.createGain(),this.sfxGain.gain.value=.5,this.sfxGain.connect(this.masterGain),this.initialized=!0,console.log("[AudioManager.init] Audio context initialized"),this.loadBgMusic()}catch(e){console.warn("[AudioManager.init] Failed:",e)}}loadBgMusic(){if(!this.bgMusic)try{this.bgMusic=new Audio("/music.ogg"),this.bgMusic.loop=!0,this.bgMusic.volume=.25,this.bgMusic.preload="auto",this.bgMusic.addEventListener("canplaythrough",()=>{this.bgMusicLoaded=!0,console.log("[AudioManager] Background music loaded")}),this.bgMusic.addEventListener("error",e=>{console.warn("[AudioManager] Failed to load background music:",e)})}catch(e){console.warn("[AudioManager] Error creating bgMusic element:",e)}}startMusic(){!this.bgMusic||!this.settings.music||(this.bgMusic.currentTime=0,this.bgMusic.volume=.25,this.bgMusic.play().catch(e=>{console.warn("[AudioManager.startMusic] Playback failed:",e)}),console.log("[AudioManager] Music started"))}stopMusic(){this.bgMusic&&(this.bgMusic.pause(),this.bgMusic.currentTime=0,console.log("[AudioManager] Music stopped"))}updateMusicState(){this.bgMusic&&(this.settings.music?this.bgMusic.paused&&this.bgMusicLoaded&&this.bgMusic.play().catch(()=>{}):this.bgMusic.pause())}playShoot(){if(!this.ctx||!this.sfxGain||!this.settings.fx)return;const e=this.ctx.currentTime,t=this.ctx.createOscillator(),s=this.ctx.createGain();t.type="sine",t.frequency.setValueAtTime(600,e),t.frequency.exponentialRampToValueAtTime(200,e+.06),s.gain.setValueAtTime(0,e),s.gain.linearRampToValueAtTime(.05,e+.015),s.gain.exponentialRampToValueAtTime(.01,e+.06),t.connect(s),s.connect(this.sfxGain),t.start(e),t.stop(e+.07)}playHit(){if(!this.ctx||!this.sfxGain||!this.settings.fx)return;const e=this.ctx.currentTime,t=this.ctx.createOscillator(),s=this.ctx.createGain();t.type="triangle",t.frequency.setValueAtTime(120,e),t.frequency.exponentialRampToValueAtTime(40,e+.1),s.gain.setValueAtTime(.1,e),s.gain.exponentialRampToValueAtTime(.01,e+.1),t.connect(s),s.connect(this.sfxGain),t.start(e),t.stop(e+.12)}playDestroy(e){if(!this.ctx||!this.sfxGain||!this.settings.fx)return;const t=this.ctx.currentTime,s=e==="large"?80:e==="medium"?120:200,i=this.ctx.sampleRate*.2,a=this.ctx.createBuffer(1,i,this.ctx.sampleRate),n=a.getChannelData(0);for(let h=0;h<i;h++)n[h]=(Math.random()*2-1)*Math.exp(-h/(this.ctx.sampleRate*.05));const o=this.ctx.createBufferSource();o.buffer=a;const r=this.ctx.createBiquadFilter();r.type="bandpass",r.frequency.value=s*4,r.Q.value=1;const d=this.ctx.createGain();d.gain.setValueAtTime(.2,t),d.gain.exponentialRampToValueAtTime(.01,t+.15),o.connect(r),r.connect(d),d.connect(this.sfxGain),o.start(t)}playCoin(){if(!this.ctx||!this.sfxGain||!this.settings.fx)return;const e=this.ctx.currentTime,t=this.ctx.createOscillator(),s=this.ctx.createGain();t.type="sine",t.frequency.setValueAtTime(880,e),t.frequency.setValueAtTime(1100,e+.05),s.gain.setValueAtTime(.1,e),s.gain.exponentialRampToValueAtTime(.01,e+.15),t.connect(s),s.connect(this.sfxGain),t.start(e),t.stop(e+.16)}playUpgrade(){if(!this.ctx||!this.sfxGain||!this.settings.fx)return;const e=this.ctx.currentTime;[523,659,784,1047].forEach((s,i)=>{const a=this.ctx.createOscillator(),n=this.ctx.createGain();a.type="triangle",a.frequency.value=s,n.gain.setValueAtTime(.08,e+i*.08),n.gain.exponentialRampToValueAtTime(.01,e+i*.08+.15),a.connect(n),n.connect(this.sfxGain),a.start(e+i*.08),a.stop(e+i*.08+.2)})}playGameOver(){if(!this.ctx||!this.sfxGain||!this.settings.fx)return;const e=this.ctx.currentTime,t=this.ctx.createOscillator(),s=this.ctx.createGain();t.type="sawtooth",t.frequency.setValueAtTime(300,e),t.frequency.exponentialRampToValueAtTime(80,e+.5),s.gain.setValueAtTime(.15,e),s.gain.linearRampToValueAtTime(.1,e+.2),s.gain.exponentialRampToValueAtTime(.01,e+.5);const i=this.ctx.createBiquadFilter();i.type="lowpass",i.frequency.setValueAtTime(1e3,e),i.frequency.exponentialRampToValueAtTime(200,e+.4),t.connect(i),i.connect(s),s.connect(this.sfxGain),t.start(e),t.stop(e+.6)}playExplosion(){if(!this.ctx||!this.sfxGain||!this.settings.fx)return;const e=this.ctx.currentTime,t=this.ctx.createOscillator(),s=this.ctx.createGain();t.type="sawtooth",t.frequency.setValueAtTime(100,e),t.frequency.exponentialRampToValueAtTime(10,e+.4),s.gain.setValueAtTime(.3,e),s.gain.exponentialRampToValueAtTime(.01,e+.4);const i=this.ctx.createBiquadFilter();i.type="lowpass",i.frequency.setValueAtTime(400,e),i.frequency.exponentialRampToValueAtTime(50,e+.3),t.connect(i),i.connect(s),s.connect(this.sfxGain),t.start(e),t.stop(e+.4)}triggerHaptic(e){this.settings.haptics&&typeof window.triggerHaptic=="function"&&window.triggerHaptic(e)}}class B{particles=[];pool;constructor(){this.pool=new M(()=>({x:0,y:0,vx:0,vy:0,life:0,maxLife:1,size:4,color:"#fff",type:"spark",rotation:0,rotationSpeed:0}),e=>{e.life=0},l.PARTICLE_POOL_SIZE)}emit(e,t,s,i,a="spark"){for(let n=0;n<i;n++){const o=this.pool.acquire(),r=Math.random()*Math.PI*2,d=a==="explosion"?3+Math.random()*5:1+Math.random()*3;o.x=e,o.y=t,o.vx=Math.cos(r)*d,o.vy=Math.sin(r)*d,o.life=1,o.maxLife=1,o.size=a==="paper"?8+Math.random()*12:a==="explosion"?6+Math.random()*8:3+Math.random()*4,o.color=s,o.type=a,o.rotation=Math.random()*Math.PI*2,o.rotationSpeed=(Math.random()-.5)*.3,this.particles.push(o)}}update(e){for(let t=this.particles.length-1;t>=0;t--){const s=this.particles[t];s.x+=s.vx*e*60,s.y+=s.vy*e*60,s.vy+=.1*e*60,s.rotation+=s.rotationSpeed*e*60,s.life-=(s.type==="paper"?.015:.025)*e*60,s.life<=0&&(this.pool.release(s),this.particles.splice(t,1))}}draw(e){for(const t of this.particles){if(e.save(),e.globalAlpha=t.life*.8,e.translate(t.x,t.y),e.rotate(t.rotation),t.type==="paper"){e.fillStyle=t.color,e.beginPath();const s=t.size*(.5+t.life*.5);e.moveTo(-s,-s/2),e.lineTo(s,-s/3),e.lineTo(s/2,s),e.lineTo(-s,s/2),e.closePath(),e.fill(),e.strokeStyle="rgba(0,0,0,0.1)",e.lineWidth=1,e.beginPath(),e.moveTo(-s,0),e.lineTo(s,0),e.stroke()}else if(t.type==="spark"||t.type==="explosion"){e.fillStyle=t.color,e.beginPath();const s=t.size*t.life;e.arc(0,0,s,0,Math.PI*2),e.fill()}else t.type,e.fillStyle=t.color,e.beginPath(),e.arc(0,0,t.size*t.life,0,Math.PI*2),e.fill();e.restore()}}clear(){for(const e of this.particles)this.pool.release(e);this.particles=[]}}class x{texts=[];add(e,t,s,i="#fff",a=20){this.texts.push({x:e,y:t,text:s,life:1,color:i,size:a})}update(e){for(let t=this.texts.length-1;t>=0;t--){const s=this.texts[t];s.y-=40*e,s.life-=.02*e*60,s.life<=0&&this.texts.splice(t,1)}}draw(e){for(const t of this.texts){e.save(),e.globalAlpha=t.life;const s=E(Math.min(1,(1-t.life)*4)),i=t.life>.8?s:t.life/.8;e.translate(t.x,t.y),e.scale(i,i),e.font="bold "+t.size+"px 'Caveat', cursive",e.textAlign="center",e.textBaseline="middle",e.fillStyle="rgba(45, 45, 45, 0.2)",e.fillText(t.text,2,2),e.fillStyle=t.color,e.fillText(t.text,0,0),e.restore()}}clear(){this.texts=[]}}const y={damage:1,fireRateMs:l.PLAYER_FIRE_RATE,bulletSpeed:l.BULLET_SPEED,moveSpeed:l.PLAYER_SPEED,pierce:0,shots:1,spread:0,maxLives:3,bulletSize:1},P={fireRate:{name:"Fire Rate",icon:"F",levels:[{name:"Quick Draw",desc:"+15% fire rate",value:1.15},{name:"Rapid Fire",desc:"+30% fire rate",value:1.3},{name:"Machine Gun",desc:"+50% fire rate",value:1.5},{name:"Bullet Storm",desc:"+75% fire rate",value:1.75},{name:"Lead Rain",desc:"+100% fire rate",value:2}]},multiShot:{name:"Multi-Shot",icon:"M",levels:[{name:"Double Tap",desc:"2 bullets",value:2},{name:"Triple Threat",desc:"3 bullets",value:3},{name:"Quad Shot",desc:"4 bullets",value:4},{name:"Penta Burst",desc:"5 bullets",value:5},{name:"Full Spread",desc:"7 bullets",value:7}]},turrets:{name:"Turret Buddy",icon:"T",levels:[{name:"Helper I",desc:"1 turret",value:1},{name:"Helper II",desc:"2 turrets",value:2},{name:"Helper III",desc:"3 turrets",value:3},{name:"Helper IV",desc:"4 turrets",value:4},{name:"Helper V",desc:"5 turrets",value:5}]}};class D{canvas;ctx;gameContainer;eventBus;particles;floatingText;audio;bulletPool;asteroidPool;bullets=[];asteroids=[];drones=[];orbitals=[];bossProjectiles=[];bossProjectileIdCounter=0;bossMinions=[];bossMinionIdCounter=0;bossAreaEffects=[];bossAreaEffectIdCounter=0;gameState="START";selectedPlane="dart";playerX=0;playerY=0;playerVelocityX=0;playerVelocityY=0;targetX=0;targetY=0;spinAngle=0;spinDirection=0;lastPlayerX=0;lives=3;maxLives=3;damageTimer=0;damageFlashTimer=0;isInvincible=!1;boss=null;bossesDefeated=0;bossAnnouncementTimer=0;survivalTime=0;coins=0;score=0;fireTimer=0;spawnTimer=0;destroyedCount=0;totalUpgrades=0;activeAbilities=[];abilityDuration=0;abilityCooldown=0;abilityChoices=[];permanentStatBoost=0;currentlyActiveAbility=null;upgrades={fireRate:0,multiShot:0,turrets:0};currentStats={...y};difficultyLevel=0;healthBonus=0;speedMultiplier=1;w=0;h=0;isMobile=!1;bgOffset=0;screenShake={x:0,y:0,intensity:0};keysDown=new Set;touchX=null;touchY=null;mouseX=null;mouseY=null;isDragging=!1;settings;lastTime=0;asteroidIdCounter=0;upgradeAutoSelectTimer=0;demoCanvas=null;demoCtx=null;demoPlaneX=0;demoPlaneY=0;demoPlaneTargetX=0;demoPlaneDirection=1;demoBullets=[];demoAsteroids=[];demoParticles=[];demoFireTimer=0;demoSpawnTimer=0;demoBgOffset=0;playerTilt=0;playerScaleX=1;playerScaleY=1;juiceTimer=0;bgDoodles=[];constructor(){console.log("[PaperPlaneGame] Initializing"),this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.gameContainer=document.getElementById("game-container"),this.eventBus=new k,this.particles=new B,this.floatingText=new x,this.settings={music:localStorage.getItem("paperPlane_music")!=="false",fx:localStorage.getItem("paperPlane_fx")!=="false",haptics:localStorage.getItem("paperPlane_haptics")!=="false"},this.audio=new w(this.settings),this.isMobile=window.matchMedia("(pointer: coarse)").matches,this.demoCanvas=document.getElementById("demoCanvas"),this.demoCanvas&&(this.demoCtx=this.demoCanvas.getContext("2d"),this.initDemoAnimation()),this.bulletPool=new M(()=>({x:0,y:0,vx:0,vy:0,damage:1,pierceRemaining:0,explosive:!1,chainLightning:!1,active:!1,fromDrone:!1,age:0,maxAge:3,size:1,color:l.PENCIL_DARK,shape:"line",wobblePhase:0,bounceRemaining:0,loop:!1,homingStrength:0,snowball:!1,snowballMax:1,sticky:!1,stuckToId:-1,stuckOffsetX:0,stuckOffsetY:0,drag:0,acceleration:0,gravity:0,splitOnHit:0,trailTimer:0,jitterOffset:0,prismSplit:!1}),e=>{e.active=!1,e.fromDrone=!1,e.age=0,e.maxAge=3,e.stuckToId=-1,e.trailTimer=0,e.prismSplit=!1},l.BULLET_POOL_SIZE),this.asteroidPool=new M(()=>({id:0,size:"medium",health:1,maxHealth:1,x:0,y:0,vx:0,vy:0,rotation:0,rotationSpeed:0,active:!1,hitFlash:0,isBossAsteroid:!1}),e=>{e.active=!1,e.isBossAsteroid=!1},l.ASTEROID_POOL_SIZE),this.setupEventListeners(),this.setupGameEvents(),this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas()),requestAnimationFrame(e=>this.gameLoop(e))}setupEventListeners(){window.addEventListener("keydown",e=>{this.keysDown.add(e.key),e.key==="Escape"&&this.gameState==="PLAYING"?this.pauseGame():e.key==="Escape"&&this.gameState==="PAUSED"&&this.resumeGame()}),window.addEventListener("keyup",e=>{this.keysDown.delete(e.key)}),this.canvas.addEventListener("touchstart",e=>{e.preventDefault(),(this.gameState==="PLAYING"||this.gameState==="BOSS")&&(this.isDragging||this.audio.triggerHaptic("light"),this.isDragging=!0,this.touchX=this.getRelativeX(e.touches[0].clientX),this.touchY=this.getRelativeY(e.touches[0].clientY))}),this.canvas.addEventListener("touchmove",e=>{e.preventDefault(),this.isDragging&&(this.gameState==="PLAYING"||this.gameState==="BOSS")&&(this.touchX=this.getRelativeX(e.touches[0].clientX),this.touchY=this.getRelativeY(e.touches[0].clientY))}),this.canvas.addEventListener("touchend",e=>{e.preventDefault(),this.isDragging=!1,this.targetX=this.playerX,this.targetY=this.playerY,this.touchX=null,this.touchY=null}),this.canvas.addEventListener("mousemove",e=>{(this.gameState==="PLAYING"||this.gameState==="BOSS")&&!this.isMobile&&(this.mouseX=this.getRelativeX(e.clientX),this.mouseY=this.getRelativeY(e.clientY))}),this.canvas.addEventListener("mouseleave",()=>{this.mouseX=null,this.mouseY=null}),document.getElementById("startButton")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.startGame()}),document.getElementById("restartButton")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.startGame()}),document.getElementById("menuButton")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.showStartScreen()}),document.getElementById("pauseBtn")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.pauseGame()}),document.getElementById("resumeButton")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.resumeGame()}),document.getElementById("pauseRestartBtn")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.startGame()}),document.getElementById("pauseMenuBtn")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.showStartScreen()}),document.getElementById("settingsBtn")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),document.getElementById("settingsModal")?.classList.remove("hidden")}),document.getElementById("settingsClose")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),document.getElementById("settingsModal")?.classList.add("hidden")}),this.setupSettingToggle("musicToggle","music"),this.setupSettingToggle("fxToggle","fx"),this.setupSettingToggle("hapticToggle","haptics"),document.getElementById("galleryButton")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.showGalleryScreen()}),document.getElementById("backFromGalleryBtn")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.hideGalleryScreen()}),document.querySelectorAll(".plane-card").forEach(e=>{e.addEventListener("click",()=>{this.audio.triggerHaptic("light");const t=e.getAttribute("data-plane");this.selectPlane(t),this.hideGalleryScreen()})}),document.querySelectorAll("#upgradeScreen .upgrade-card").forEach(e=>{e.addEventListener("click",()=>{if(this.gameState!=="UPGRADE")return;const t=e.getAttribute("data-item-id");t&&(e.classList.contains("maxed")||(this.audio.triggerHaptic("medium"),this.selectItem(t)))})}),document.querySelectorAll("#abilityScreen .ability-card").forEach(e=>{e.addEventListener("click",()=>{if(this.gameState!=="ABILITY_CHOICE")return;const t=e.getAttribute("data-ability-id");t&&(this.audio.triggerHaptic("medium"),this.selectAbility(t))})})}setupSettingToggle(e,t){const s=document.getElementById(e);s&&(s.classList.toggle("active",this.settings[t]),s.addEventListener("click",()=>{this.settings[t]=!this.settings[t],s.classList.toggle("active",this.settings[t]),localStorage.setItem("paperPlane_"+t,this.settings[t].toString()),this.audio.triggerHaptic("light"),t==="music"&&this.audio.updateMusicState()}))}setupGameEvents(){this.eventBus.on("ASTEROID_DESTROYED",e=>{const{asteroid:t,coins:s}=e;console.log("[Event] ASTEROID_DESTROYED",t.size,"coins:",s),this.coins+=s,this.audio.playDestroy(t.size),this.audio.playCoin(),this.audio.triggerHaptic(t.size==="large"?"heavy":"medium"),this.particles.emit(t.x,t.y,l.PAPER_BG,12,"paper"),this.particles.emit(t.x,t.y,l.PENCIL_DARK,8,"explosion"),this.floatingText.add(t.x,t.y,"+"+s,l.COIN_GOLD,24);const i=t.size==="large"?.5:t.size==="medium"?.3:.15;this.triggerScreenShake(i),this.gameState!=="BOSS"&&(this.destroyedCount++,this.updateProgressBar(),this.destroyedCount>=this.getAsteroidsForNextUpgrade()&&this.gameState==="PLAYING"&&(console.log("[Game] Triggering upgrade after",this.destroyedCount,"asteroids destroyed"),this.showUpgradeScreen()))}),this.eventBus.on("ASTEROID_HIT",e=>{const{asteroid:t,damage:s}=e;this.audio.playHit(),this.audio.triggerHaptic("light"),t.hitFlash=.2,this.particles.emit(t.x,t.y,l.PENCIL_LIGHT,4,"spark")}),this.eventBus.on("PLAYER_HIT",()=>{this.isInvincible||(this.lives--,console.log("[Event] PLAYER_HIT - Lives remaining:",this.lives),this.lives<=0?this.gameOver():this.triggerDamageEffect())}),this.eventBus.on("UPGRADE_ROUND_START",()=>{console.log("[Event] UPGRADE_ROUND_START"),this.showUpgradeScreen()})}selectPlane(e){console.log("[selectPlane]",e),this.selectedPlane=e,document.querySelectorAll(".plane-card").forEach(t=>{t.classList.toggle("selected",t.getAttribute("data-plane")===e)})}showGalleryScreen(){console.log("[showGalleryScreen]"),document.getElementById("startScreen")?.classList.add("hidden"),document.getElementById("galleryScreen")?.classList.remove("hidden")}hideGalleryScreen(){console.log("[hideGalleryScreen]"),document.getElementById("galleryScreen")?.classList.add("hidden"),document.getElementById("startScreen")?.classList.remove("hidden")}resizeCanvas(){this.w=this.gameContainer.clientWidth,this.h=this.gameContainer.clientHeight,this.canvas.width=this.w,this.canvas.height=this.h,this.playerX===0&&(this.playerX=this.w/2,this.playerY=this.h*l.PLAYER_Y_RATIO,this.targetX=this.w/2,this.targetY=this.h*l.PLAYER_Y_RATIO),console.log("[resizeCanvas]",this.w,"x",this.h)}getRelativeX(e){const t=this.gameContainer.getBoundingClientRect();return e-t.left}getRelativeY(e){const t=this.gameContainer.getBoundingClientRect();return e-t.top}startGame(){console.log("[startGame] Plane:",this.selectedPlane),this.audio.init(),this.audio.startMusic(),this.gameState="PLAYING",this.survivalTime=0,this.coins=0,this.score=0,this.fireTimer=0,this.spawnTimer=0,this.destroyedCount=0,this.totalUpgrades=0,this.difficultyLevel=0,this.healthBonus=0,this.speedMultiplier=1,this.generateDoodles(),this.upgrades={fireRate:0,multiShot:0,turrets:0},this.currentStats={...y},this.maxLives=y.maxLives,this.lives=this.maxLives,this.damageTimer=0,this.damageFlashTimer=0,this.isInvincible=!1,this.boss=null,this.bossesDefeated=0,this.bossAnnouncementTimer=0,this.activeAbilities=[],this.abilityDuration=0,this.abilityCooldown=0,this.permanentStatBoost=0,this.currentlyActiveAbility=null,this.abilityChoices=[],this.updateAbilityUI(),this.updateLivesDisplay(),this.playerX=this.w/2,this.playerY=this.h*l.PLAYER_Y_RATIO,this.targetX=this.w/2,this.targetY=this.h*l.PLAYER_Y_RATIO,this.playerVelocityX=0,this.playerVelocityY=0,this.spinAngle=0,this.spinDirection=0,this.lastPlayerX=this.w/2,this.mouseX=null,this.mouseY=null,this.touchX=null,this.touchY=null;for(const e of this.bullets)this.bulletPool.release(e);this.bullets=[];for(const e of this.asteroids)this.asteroidPool.release(e);this.asteroids=[],this.drones=[],this.orbitals=[],this.bossProjectiles=[],this.bossMinions=[],this.bossAreaEffects=[],this.particles.clear(),this.floatingText.clear(),document.getElementById("startScreen")?.classList.add("hidden"),document.getElementById("gameOverScreen")?.classList.add("hidden"),document.getElementById("pauseScreen")?.classList.add("hidden"),document.getElementById("upgradeScreen")?.classList.add("hidden"),document.getElementById("abilityScreen")?.classList.add("hidden"),document.getElementById("galleryScreen")?.classList.add("hidden"),document.getElementById("hud")?.classList.remove("hidden"),document.getElementById("pauseBtn")?.classList.remove("hidden"),document.getElementById("itemInventory")?.classList.remove("hidden"),this.updateHUD(),this.recalculateStats(),this.updateProgressBar()}showStartScreen(){console.log("[showStartScreen]"),this.gameState="START",this.audio.stopMusic(),document.getElementById("startScreen")?.classList.remove("hidden"),document.getElementById("gameOverScreen")?.classList.add("hidden"),document.getElementById("pauseScreen")?.classList.add("hidden"),document.getElementById("upgradeScreen")?.classList.add("hidden"),document.getElementById("abilityScreen")?.classList.add("hidden"),document.getElementById("galleryScreen")?.classList.add("hidden"),document.getElementById("hud")?.classList.add("hidden"),document.getElementById("pauseBtn")?.classList.add("hidden"),document.getElementById("itemInventory")?.classList.add("hidden"),this.initDemoAnimation()}pauseGame(){this.gameState==="PLAYING"&&(console.log("[pauseGame]"),this.gameState="PAUSED",document.getElementById("pauseScreen")?.classList.remove("hidden"))}resumeGame(){this.gameState==="PAUSED"&&(console.log("[resumeGame]"),this.gameState="PLAYING",document.getElementById("pauseScreen")?.classList.add("hidden"))}gameOver(){console.log("[gameOver] Time:",(this.survivalTime/1e3).toFixed(1),"s, Coins:",this.coins),this.gameState="GAME_OVER",this.audio.playGameOver(),this.audio.stopMusic(),this.audio.triggerHaptic("error");const e=Math.floor(this.score);typeof window.submitScore=="function"&&(window.submitScore(e),console.log("[gameOver] Score submitted:",e));const t=Math.floor(this.survivalTime/6e4),s=Math.floor(this.survivalTime%6e4/1e3);document.getElementById("finalTime").textContent=t+":"+s.toString().padStart(2,"0"),document.getElementById("finalCoins").textContent=e.toString();const i=this.upgrades.fireRate+this.upgrades.multiShot+this.upgrades.turrets;document.getElementById("summaryItems").textContent=i.toString(),document.getElementById("summaryCursed").textContent=this.bossesDefeated.toString(),document.getElementById("hud")?.classList.add("hidden"),document.getElementById("pauseBtn")?.classList.add("hidden"),document.getElementById("itemInventory")?.classList.add("hidden"),document.getElementById("gameOverScreen")?.classList.remove("hidden")}showUpgradeScreen(){if(this.gameState==="UPGRADE")return;console.log("[showUpgradeScreen] Showing upgrade tree selection"),this.gameState="UPGRADE",this.audio.triggerHaptic("success");const e=["fireRate","multiShot","turrets"];document.querySelectorAll("#upgradeScreen .upgrade-card").forEach((s,i)=>{const a=e[i];if(!a)return;const n=P[a],o=this.upgrades[a],r=o>=5;s.classList.toggle("maxed",r),s.setAttribute("data-item-id",a),s.querySelectorAll(".level-dots .dot").forEach((c,f)=>{c.classList.toggle("filled",f<o)});const h=s.querySelector(".next-name"),u=s.querySelector(".next-bonus");if(r)h&&(h.textContent="MAXED!"),u&&(u.textContent="");else{const c=n.levels[o];h&&(h.textContent=c.name),u&&(u.textContent=c.desc)}}),document.getElementById("upgradeScreen")?.classList.remove("hidden")}selectItem(e){if(this.gameState!=="UPGRADE")return;const t=e;P[t]&&this.applyUpgrade(t)}applyUpgrade(e){if(this.upgrades[e]>=5){console.log("[applyUpgrade] Tree already maxed:",e);return}this.upgrades[e]++,console.log("[applyUpgrade] Upgraded",e,"to level",this.upgrades[e]),this.audio.playUpgrade(),this.audio.triggerHaptic("success"),this.destroyedCount=0,this.totalUpgrades++,this.recalculateStats(),document.getElementById("upgradeScreen")?.classList.add("hidden"),this.totalUpgrades%2===0&&this.bossesDefeated<6?(console.log("[applyUpgrade] Triggering boss fight #"+(this.bossesDefeated+1)+" after upgrade "+this.totalUpgrades),this.startBossFight()):(this.gameState="PLAYING",this.updateProgressBar())}startBossFight(){const e=this.bossesDefeated+1,t=I[Math.min(this.bossesDefeated,I.length-1)],s=g[t];console.log("[startBossFight] Boss fight #"+e+" ("+s.name+") starting!");for(const r of this.asteroids)r.active=!1,this.asteroidPool.release(r);this.asteroids=[],this.bossProjectiles=[],this.bossMinions=[],this.bossAreaEffects=[],this.bossAnnouncementTimer=2.5;const i=document.getElementById("bossAnnouncement"),a=i?.querySelector(".boss-text");a&&(a.innerHTML=s.name+'<br><span style="font-size: 0.5em; font-weight: 400;">'+s.subtitle+"</span>"),i&&i.classList.add("active");const n=1+(e-1)*.3,o=Math.floor(l.BOSS_HEALTH*s.healthMult*n);this.boss={type:t,x:this.w/2,y:-120,vx:0,vy:0,targetY:l.BOSS_Y_POSITION,health:o,maxHealth:o,rotation:0,waveTimer:2e3,attacksRemaining:0,attackTimer:0,totalAttacks:0,active:!0,entering:!0,defeated:!1,pulsePhase:0,movePhase:0,burstCount:0,specialTimer:0,isSpecial:!1,phase:0},this.gameState="BOSS",this.audio.triggerHaptic("heavy"),setTimeout(()=>this.audio.triggerHaptic("heavy"),150),setTimeout(()=>this.audio.triggerHaptic("heavy"),300),this.triggerScreenShake(8)}updateUpgradeTimer(){const e=document.getElementById("upgradeTimer");e&&(e.textContent=Math.ceil(this.upgradeAutoSelectTimer/1e3).toString())}updateHUD(){const e=Math.floor(this.survivalTime/6e4),t=Math.floor(this.survivalTime%6e4/1e3);document.getElementById("timeDisplay").textContent=e+":"+t.toString().padStart(2,"0"),document.getElementById("coinDisplay").textContent=Math.floor(this.score).toString()}getAsteroidsForNextUpgrade(){return Math.floor(15*Math.pow(1.5,this.totalUpgrades))}updateProgressBar(){const e=this.getAsteroidsForNextUpgrade(),t=Math.min(this.destroyedCount/e,1),s=document.getElementById("progressFill");s&&(s.style.width=t*100+"%");const i=document.getElementById("progressText");i&&(i.textContent=this.destroyedCount+"/"+e)}recalculateStats(){console.log("[recalculateStats] Recalculating from upgrade tree:",this.upgrades);const e=this.upgrades.fireRate>0?P.fireRate.levels[this.upgrades.fireRate-1].value:1,t=this.upgrades.multiShot>0?P.multiShot.levels[this.upgrades.multiShot-1].value:1;let s=1,i=1,a=1,n=0;if(this.currentlyActiveAbility&&(this.currentlyActiveAbility.id.startsWith("turbo")||this.currentlyActiveAbility.id==="turbo")&&this.abilityDuration>0&&this.currentlyActiveAbility){const d=this.currentlyActiveAbility.power||1,h=this.currentlyActiveAbility.tier;s=d,i=1+(d-1)*.25,h>=3&&(n=Math.floor((h-2)/2)),h>=4&&(a=1.5+(h-4)*.25)}const r=1+this.permanentStatBoost;this.currentStats={damage:y.damage*a*r,fireRateMs:y.fireRateMs/(e*s*r),bulletSpeed:y.bulletSpeed*r,moveSpeed:y.moveSpeed*i*r,pierce:y.pierce,shots:t+n,spread:t+n>1?8+(t+n-2)*4:0,maxLives:this.maxLives,bulletSize:y.bulletSize},this.rebuildTurrets()}rebuildTurrets(){const e=this.upgrades.turrets>0?P.turrets.levels[this.upgrades.turrets-1].value:0;console.log("[rebuildTurrets] Building",e,"turrets"),this.drones=[];for(let t=0;t<e;t++)this.drones.push({x:this.playerX,y:this.playerY,targetX:this.playerX,targetY:this.playerY,wanderTimer:0,fireTimer:T(200,800),facingAngle:-Math.PI/2,active:!0})}updateUpgradeTreeUI(){const e=document.getElementById("itemInventory");if(!e)return;e.innerHTML="";const t=["fireRate","multiShot","turrets"];for(const s of t){const i=this.upgrades[s];if(i===0)continue;const a=document.createElement("div");a.className="item-chip";const n=P[s];a.textContent=n.name+" Lv"+i,e.appendChild(a)}}updateOrbitals(e){if(this.orbitals.length!==0)for(const t of this.orbitals)t.angle+=e*1.2,t.x=this.playerX+Math.cos(t.angle)*t.radius,t.y=this.playerY+Math.sin(t.angle)*t.radius}drawOrbitals(){if(this.orbitals.length===0)return;const e=this.ctx;for(const t of this.orbitals)e.save(),e.translate(t.x,t.y),t.type==="shield"?(e.strokeStyle="#66aaff",e.lineWidth=2,e.beginPath(),e.arc(0,0,10,0,Math.PI*2),e.stroke()):t.type==="prism"?(e.strokeStyle="#cc88ff",e.lineWidth=2,e.beginPath(),e.moveTo(0,-8),e.lineTo(7,6),e.lineTo(-7,6),e.closePath(),e.stroke()):(e.strokeStyle="#ffd27d",e.lineWidth=2,e.beginPath(),e.arc(0,0,8,0,Math.PI*2),e.stroke()),e.restore()}getAbilityIconSvg(e){const t="currentColor";return e==="shield"?`<svg viewBox="0 0 24 24" class="ability-svg">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" fill="none" stroke="${t}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`:e==="blast"?`<svg viewBox="0 0 24 24" class="ability-svg">
        <path d="M12 2 L15 9 L22 9 L16 14 L18 21 L12 17 L6 21 L8 14 L2 9 L9 9 Z" fill="none" stroke="${t}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`:e==="turbo"?`<svg viewBox="0 0 24 24" class="ability-svg">
        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="none" stroke="${t}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`:""}showAbilityScreen(e=1){console.log("[showAbilityScreen] Showing tier "+e+" ability selection"),this.gameState="ABILITY_CHOICE",this.audio.triggerHaptic("success");const t=Math.min(e-1,A.length-1);this.abilityChoices=[...A[t]];const s=document.querySelector("#abilityScreen .ability-title"),i=document.querySelector("#abilityScreen .ability-subtitle"),a=["","BOSS DEFEATED!","ELITE BOSS DEFEATED!","CHAMPION DEFEATED!","LEGENDARY BOSS DEFEATED!","MYTHIC BOSS DEFEATED!","FINAL BOSS DEFEATED!"],n=["","Choose your Ultimate Ability","Choose an Enhanced Power","Choose a Powerful Upgrade","Choose an Epic Ability","Choose a Legendary Power","Choose your Final Blessing"];s&&(s.textContent=a[e]||"BOSS DEFEATED!"),i&&(i.textContent=n[e]||"Choose your reward"),document.querySelectorAll("#abilityScreen .ability-card").forEach((r,d)=>{const h=this.abilityChoices[d];if(!h)return;r.setAttribute("data-ability-id",h.id),r.setAttribute("data-tier",e.toString());const u=r.querySelector(".ability-card-title"),c=r.querySelector(".ability-card-desc"),f=r.querySelector(".ability-card-icon"),S=r.querySelector(".ability-card-charges");u&&(u.textContent=h.name),c&&(c.textContent=h.description),f&&(f.innerHTML=this.getAbilityIconSvg(h.icon)),S&&(S.textContent=h.charges+" USE"+(h.charges>1?"S":""))}),document.getElementById("abilityScreen")?.classList.remove("hidden")}selectAbility(e){console.log("[selectAbility]",e);const t=this.abilityChoices.find(i=>i.id===e);if(!t)return;const s=this.activeAbilities.find(i=>i.id===t.id);if(s)s.charges+=t.charges,console.log("[selectAbility] Added "+t.charges+" charges to existing slot, total: "+s.charges),this.floatingText.add(this.playerX,this.playerY-80,"+"+t.charges+" CHARGES!","#44ff44",2);else{const i={...t,instanceId:Date.now()+Math.random()};this.activeAbilities.push(i),this.floatingText.add(this.playerX,this.playerY-80,t.name.toUpperCase()+"!","#ff4444",2)}this.audio.playUpgrade(),this.audio.triggerHaptic("success"),document.getElementById("abilityScreen")?.classList.add("hidden"),this.gameState="PLAYING",this.destroyedCount=0,this.updateProgressBar(),this.updateAbilityUI()}triggerAbility(e){if(this.activeAbilities.length===0||this.gameState!=="PLAYING"&&this.gameState!=="BOSS")return;const t=e?this.activeAbilities.findIndex(h=>h.instanceId===e):0;if(t===-1)return;const s=this.activeAbilities[t];if(s.charges<=0)return;console.log("[triggerAbility]",s.id,"tier:",s.tier),s.charges--,this.audio.triggerHaptic("heavy"),this.triggerScreenShake(12+s.tier*2);const a=(h=>h.startsWith("shield")||h==="invincibility"?"shield":h.startsWith("blast")||h==="destruction"?"blast":"turbo")(s.id),n=s.tier,o=s.power||1,r=s.duration||5,d={shield:["Paper Shield","Reinforced Paper","Steel Origami","Diamond Fold","Origami Fortress","Paper God"][n-1]||"Shield",blast:["Eraser Blast","Eraser Storm","Nuclear Eraser","Black Hole","Eraser Apocalypse","Reality Eraser"][n-1]||"Blast",turbo:["Ink Overdrive","Pencil Fury","Graphite Rush","Ink Explosion","Rainbow Ink","Eternal Ink"][n-1]||"Overdrive"};if(this.floatingText.add(this.playerX,this.playerY-100,d[a].toUpperCase()+"!","#ff4444",2.5),a==="shield")this.isInvincible=!0,this.abilityDuration=r,this.damageTimer=r,this.currentlyActiveAbility=s,n>=3&&this.floatingText.add(this.playerX,this.playerY-60,"REFLECT ON!","#44ff44",1.5);else if(a==="blast"){if(this.asteroids.forEach(h=>{h.active&&(this.particles.emit(h.x,h.y,l.PENCIL_DARK,10+n*3,"explosion"),h.active=!1,this.score+=50+n*25)}),this.boss&&this.boss.active&&o>1){const h=o;this.boss.health-=h,this.floatingText.add(this.boss.x,this.boss.y,"-"+h+" BOSS!","#ff6644",2),this.particles.emit(this.boss.x,this.boss.y,"#ff4444",15+n*5,"explosion"),this.boss.health<=0&&this.defeatBoss()}n>=6&&this.triggerScreenShake(25),this.audio.playExplosion(),s.charges<=0&&this.activeAbilities.splice(t,1)}else a==="turbo"&&(this.abilityDuration=r,this.currentlyActiveAbility=s,n>=6&&this.permanentStatBoost<.25&&(this.permanentStatBoost+=.25,this.floatingText.add(this.playerX,this.playerY-60,"+25% PERMANENT!","#ffcc00",2)),this.recalculateStats());this.updateAbilityUI()}deactivateAbility(){if(!this.currentlyActiveAbility)return;console.log("[deactivateAbility]",this.currentlyActiveAbility.id);const e=this.currentlyActiveAbility.id,t=e.startsWith("shield")||e==="invincibility"?"shield":e.startsWith("blast")||e==="destruction"?"blast":"turbo";if(t==="shield"?(this.isInvincible=!1,this.damageTimer=0):t==="turbo"&&this.recalculateStats(),this.currentlyActiveAbility.charges<=0){const s=this.activeAbilities.findIndex(i=>i.instanceId===this.currentlyActiveAbility.instanceId);s!==-1&&this.activeAbilities.splice(s,1)}this.currentlyActiveAbility=null,this.abilityDuration=0,this.updateAbilityUI()}updateAbilities(e){if(this.abilityDuration>0){this.abilityDuration-=e;const t=document.querySelector(".ability-slot.active .timer");t&&(t.textContent=Math.ceil(this.abilityDuration)+"s"),this.abilityDuration<=0&&this.deactivateAbility()}}updateAbilityUI(){const e=document.getElementById("abilitySlots");e&&(e.innerHTML="",this.activeAbilities.forEach(t=>{const s=document.createElement("div");s.className="ability-slot";const i=this.currentlyActiveAbility?.instanceId===t.instanceId;i&&s.classList.add("active"),t.charges<=0&&(!i||this.abilityDuration<=0)&&s.classList.add("cooldown");const n=t.id.startsWith("shield")?"shield":t.id.startsWith("blast")?"blast":"turbo",o=i&&this.abilityDuration>0?`<div class="timer">${Math.ceil(this.abilityDuration)}s</div>`:"";s.innerHTML=`
        <div class="icon">${this.getAbilityIconSvg(n)}</div>
        <div class="label">${t.name.split(" ")[0]}</div>
        ${t.charges>0?`<div class="ability-indicator">${t.charges}</div>`:""}
        ${o}
      `,s.addEventListener("click",()=>{(this.gameState==="PLAYING"||this.gameState==="BOSS")&&this.triggerAbility(t.instanceId)}),e.appendChild(s)}))}updateLivesDisplay(){const e=document.getElementById("livesDisplay");if(e){e.innerHTML="";for(let t=0;t<this.maxLives;t++){const s=document.createElement("span");s.className="life-heart"+(t<this.lives?" filled":" empty"),s.innerHTML="&#9829;",e.appendChild(s)}}}triggerDamageEffect(){console.log("[triggerDamageEffect] Starting damage animation"),this.isInvincible=!0,this.damageTimer=1.5,this.damageFlashTimer=0;const e=document.getElementById("damageOverlay");e&&(e.classList.add("active"),setTimeout(()=>{e.classList.remove("active")},300)),this.updateLivesDisplay(),this.audio.triggerHaptic("error"),this.triggerScreenShake(8),this.eventBus.emit("ON_DAMAGE",{lives:this.lives})}updateDamageState(e){this.isInvincible&&(this.damageTimer-=e,this.damageFlashTimer+=e*12,this.damageTimer<=0&&(this.isInvincible=!1,this.damageTimer=0,this.damageFlashTimer=0))}triggerScreenShake(e){this.screenShake.intensity=Math.max(this.screenShake.intensity,e)}updatePlayer(e){const t=l.PLAYER_WIDTH/2+10,s=100,i=60,a=this.currentStats.moveSpeed,n=this.playerX,o=this.playerY;!this.isMobile&&this.mouseX!==null&&this.mouseY!==null?(this.targetX=this.mouseX,this.targetY=this.mouseY-30):this.isMobile&&this.isDragging&&this.touchX!==null&&this.touchY!==null?(this.targetX=this.touchX,this.targetY=this.touchY-80):!this.isMobile&&this.mouseX===null&&((this.keysDown.has("ArrowLeft")||this.keysDown.has("a")||this.keysDown.has("A"))&&(this.targetX=this.playerX-a*e*60),(this.keysDown.has("ArrowRight")||this.keysDown.has("d")||this.keysDown.has("D"))&&(this.targetX=this.playerX+a*e*60),(this.keysDown.has("ArrowUp")||this.keysDown.has("w")||this.keysDown.has("W"))&&(this.targetY=this.playerY-a*e*60),(this.keysDown.has("ArrowDown")||this.keysDown.has("s")||this.keysDown.has("S"))&&(this.targetY=this.playerY+a*e*60)),this.targetX=v(this.targetX,t,this.w-t),this.targetY=v(this.targetY,s,this.h-i);const r=this.playerX;if(this.selectedPlane==="glider")this.playerVelocityX=p(this.playerVelocityX,this.targetX-this.playerX,.12),this.playerVelocityY=p(this.playerVelocityY,this.targetY-this.playerY,.12),this.playerX+=this.playerVelocityX,this.playerY+=this.playerVelocityY;else{const f=this.mouseX!==null||this.isDragging?.25:.3;this.playerX=p(this.playerX,this.targetX,f),this.playerY=p(this.playerY,this.targetY,f)}const d=this.playerX-r;this.playerTilt=p(this.playerTilt,v(d*.05,-.4,.4),.1),this.playerScaleX=p(this.playerScaleX,1,.15),this.playerScaleY=p(this.playerScaleY,1,.15),this.playerX=v(this.playerX,t,this.w-t),this.playerY=v(this.playerY,s,this.h-i),this.playerVelocityX=this.playerX-n,this.playerVelocityY=this.playerY-o;const h=Math.hypot(this.playerVelocityX,this.playerVelocityY);h>.5&&this.eventBus.emit("ON_MOVE",{speed:h});const u=this.playerX-this.lastPlayerX;this.spinDirection===0&&Math.abs(u)>8&&(this.spinDirection=u>0?1:-1,this.spinAngle=0,this.audio.triggerHaptic("medium")),this.spinDirection!==0&&(this.spinAngle+=this.spinDirection*.35*e*60,Math.abs(this.spinAngle)>=Math.PI*2&&(this.spinAngle=0,this.spinDirection=0)),this.lastPlayerX=this.playerX}fireBullets(){this.playerScaleY=.85,this.playerScaleX=1.15;const e=this.currentStats,t=e.shots,s=e.spread,i=-Math.PI/2,a=i-s/2*Math.PI/180,n=t>1?s*Math.PI/180/(t-1):0;for(let o=0;o<t;o++){let r=t===1?i:a+n*o;this.selectedPlane==="bomber"&&(r+=(Math.random()-.5)*4*Math.PI/180),this.spawnBullet(r,e)}this.audio.playShoot(),this.eventBus.emit("ON_FIRE",{stats:this.currentStats})}getShotOrigin(){return{x:this.playerX,y:this.playerY-l.PLAYER_HEIGHT/2}}spawnBullet(e,t,s=!1){const i=this.getShotOrigin(),a=this.bulletPool.acquire();return a.x=i.x,a.y=i.y,a.vx=Math.cos(e)*t.bulletSpeed,a.vy=Math.sin(e)*t.bulletSpeed,a.damage=t.damage,a.pierceRemaining=t.pierce,a.explosive=!1,a.chainLightning=!1,a.active=!0,a.fromDrone=s,a.age=0,a.maxAge=3.2,a.size=t.bulletSize,a.color=l.PENCIL_DARK,a.shape="line",a.wobblePhase=Math.random()*Math.PI*2,a.bounceRemaining=0,a.loop=!1,a.homingStrength=0,a.snowball=!1,a.snowballMax=1,a.sticky=!1,a.stuckToId=-1,a.drag=0,a.acceleration=0,a.gravity=0,a.splitOnHit=0,a.trailTimer=0,a.jitterOffset=T(-1.5,1.5),a.prismSplit=!1,this.bullets.push(a),a}updateBullets(e){for(let t=this.bullets.length-1;t>=0;t--){const s=this.bullets[t];if(!s.active){this.bulletPool.release(s),this.bullets.splice(t,1);continue}if(s.age+=e,s.age>s.maxAge){this.bulletPool.release(s),this.bullets.splice(t,1);continue}if(s.sticky&&s.stuckToId>=0){const i=this.asteroids.find(a=>a.id===s.stuckToId);if(!i){this.bulletPool.release(s),this.bullets.splice(t,1);continue}s.x=i.x+s.stuckOffsetX,s.y=i.y+s.stuckOffsetY,s.trailTimer+=e,s.trailTimer>=.35&&(s.trailTimer=0,i.health-=s.damage*.35,i.hitFlash=.2,i.health<=0&&this.handleAsteroidDestroyed(i));continue}if(s.snowball){const i=1+Math.min(1,s.age/1.2)*(s.snowballMax-1);s.size=this.currentStats.bulletSize*i}if(s.homingStrength>0&&this.asteroids.length>0){const i=this.findNearestAsteroid(s.x,s.y,400);if(i){const a=i.x-s.x,n=i.y-s.y,o=Math.max(1,Math.sqrt(a*a+n*n)),r=s.homingStrength*e*60;s.vx=p(s.vx,a/o*this.currentStats.bulletSpeed,r),s.vy=p(s.vy,n/o*this.currentStats.bulletSpeed,r)}}if(s.acceleration>0){const i=Math.atan2(s.vy,s.vx),n=Math.sqrt(s.vx*s.vx+s.vy*s.vy)*(1+s.acceleration*e*60);s.vx=Math.cos(i)*n,s.vy=Math.sin(i)*n}if(s.drag>0){const i=Math.max(0,1-s.drag*e*60);s.vx*=i,s.vy*=i}s.gravity>0&&(s.vy+=s.gravity*e*60),s.x+=s.vx*e*60,s.y+=s.vy*e*60,s.loop?(s.x<-30&&(s.x=this.w+30),s.x>this.w+30&&(s.x=-30),s.y<-30&&(s.y=this.h+30),s.y>this.h+30&&(s.y=-30)):(s.y<-80||s.y>this.h+80||s.x<-80||s.x>this.w+80)&&(this.bulletPool.release(s),this.bullets.splice(t,1))}}findNearestAsteroid(e,t,s){let i=null,a=s;for(const n of this.asteroids){if(!n.active)continue;const o=b(e,t,n.x,n.y);o<a&&(a=o,i=n)}return i}handleAsteroidDestroyed(e,t){if(!e.active)return;e.active=!1;const i=l.ASTEROID_SIZES[e.size].coins;this.eventBus.emit("ASTEROID_DESTROYED",{asteroid:e,coins:i}),this.eventBus.emit("ON_KILL",{asteroid:e,sourceBullet:t}),e.isBossAsteroid||this.splitAsteroid(e),t?.explosive&&this.handleExplosion(e.x,e.y,2,80),t?.chainLightning&&this.handleChainLightning(e.x,e.y,3,2),this.asteroidPool.release(e),this.asteroids=this.asteroids.filter(a=>a.id!==e.id)}spawnAsteroid(e,t,s,i,a){if(!e){const r=this.survivalTime/6e4,d=this.bossesDefeated*.05,h=Math.min(.55,.2+r*.05+d),u=Math.min(.4,.35+r*.02),c=Math.random();c<h?e="large":c<h+u?e="medium":e="small"}const n=l.ASTEROID_SIZES[e],o=this.asteroidPool.acquire();o.id=++this.asteroidIdCounter,o.size=e,o.maxHealth=n.health+this.healthBonus,o.health=o.maxHealth,o.x=t??T(n.radius*.5,this.w-n.radius*.5),o.y=s??-n.radius-10,o.vx=i??T(-1.5,1.5),o.vy=a??n.speed*this.speedMultiplier,o.rotation=Math.random()*Math.PI*2,o.rotationSpeed=(Math.random()-.5)*.03,o.active=!0,o.hitFlash=0,o.isBossAsteroid=!1,this.asteroids.push(o)}updateAsteroids(e){for(let t=this.asteroids.length-1;t>=0;t--){const s=this.asteroids[t];s.x+=s.vx*e*60,s.y+=s.vy*e*60,s.rotation+=s.rotationSpeed*e*60;const i=l.ASTEROID_SIZES[s.size].speed*.5;s.vy<i&&(s.vy+=.08*e*60),s.hitFlash>0&&(s.hitFlash-=e);const a=l.ASTEROID_SIZES[s.size];s.x<0?(s.x=0,s.vx=Math.abs(s.vx)*.9):s.x>this.w&&(s.x=this.w,s.vx=-Math.abs(s.vx)*.9),s.y>this.h+a.radius+50&&(this.asteroidPool.release(s),this.asteroids.splice(t,1))}}updateDrones(e){if(this.drones.length===0)return;const t=this.currentStats.fireRateMs*1.6,s=1,i=this.currentStats.pierce>0?1:0,a=l.DRONE_ORBIT_RADIUS*1.5,n=25;for(const o of this.drones){if(o.wanderTimer-=e*1e3,o.wanderTimer<=0){const c=l.DRONE_ORBIT_RADIUS*.8,f=Math.random()*Math.PI*2;o.targetX=this.playerX+Math.cos(f)*(20+Math.random()*c),o.targetY=this.playerY+Math.sin(f)*(20+Math.random()*c),o.wanderTimer=400+Math.random()*600}const r=b(o.targetX,o.targetY,this.playerX,this.playerY);if(r>a){const c=Math.atan2(this.playerY-o.targetY,this.playerX-o.targetX);o.targetX+=Math.cos(c)*(r-a),o.targetY+=Math.sin(c)*(r-a)}o.x=p(o.x,o.targetX,.08),o.y=p(o.y,o.targetY,.08);const d=b(o.x,o.y,this.playerX,this.playerY);if(d>a){const c=Math.atan2(this.playerY-o.y,this.playerX-o.x);o.x=this.playerX-Math.cos(c)*a,o.y=this.playerY-Math.sin(c)*a}else if(d<n){const c=Math.atan2(o.y-this.playerY,o.x-this.playerX);o.x=this.playerX+Math.cos(c)*n,o.y=this.playerY+Math.sin(c)*n}let h=null,u=-1/0;for(const c of this.asteroids){let S=-b(o.x,o.y,c.x,c.y);c.health>=4&&(S+=200),S>u&&(u=S,h=c)}if(this.boss&&this.boss.active&&this.gameState==="BOSS"){const f=-b(o.x,o.y,this.boss.x,this.boss.y)+500;f>u&&(u=f,h=this.boss)}if(h){let f=Math.atan2(h.y-o.y,h.x-o.x)-o.facingAngle;for(;f>Math.PI;)f-=Math.PI*2;for(;f<-Math.PI;)f+=Math.PI*2;o.facingAngle+=f*.15}else{let c=-Math.PI/2-o.facingAngle;for(;c>Math.PI;)c-=Math.PI*2;for(;c<-Math.PI;)c+=Math.PI*2;o.facingAngle+=c*.1}if(o.fireTimer-=e*1e3,o.fireTimer<=0&&h){const c=this.bulletPool.acquire();c.x=o.x,c.y=o.y,c.vx=Math.cos(o.facingAngle)*this.currentStats.bulletSpeed*.8,c.vy=Math.sin(o.facingAngle)*this.currentStats.bulletSpeed*.8,c.damage=s,c.pierceRemaining=i,c.explosive=!1,c.chainLightning=!1,c.active=!0,c.fromDrone=!0,c.age=0,c.maxAge=2.2,c.size=this.currentStats.bulletSize*.8,c.color=l.PENCIL_DARK,c.shape="line",c.wobblePhase=Math.random()*Math.PI*2,c.bounceRemaining=0,c.loop=!1,c.homingStrength=0,c.snowball=!1,c.snowballMax=1,c.sticky=!1,c.stuckToId=-1,c.drag=0,c.acceleration=0,c.gravity=0,c.splitOnHit=0,c.trailTimer=0,c.jitterOffset=T(-1,1),c.prismSplit=!1,this.bullets.push(c),o.fireTimer=t}else o.fireTimer<=0&&(o.fireTimer=t)}}checkCollisions(){for(let e=this.bullets.length-1;e>=0;e--){const t=this.bullets[e];if(t.active)for(let s=this.asteroids.length-1;s>=0;s--){const i=this.asteroids[s];if(!i.active)continue;const a=l.ASTEROID_SIZES[i.size],n=b(t.x,t.y,i.x,i.y);if(n<a.radius+5){const o=t.snowball?1+Math.min(1,t.age/1.2)*(t.snowballMax-1):1,r=t.damage*o;if(i.health-=r,i.hitFlash=.15,this.eventBus.emit("ASTEROID_HIT",{asteroid:i,damage:r}),this.eventBus.emit("ON_HIT",{asteroid:i,bullet:t,damage:r}),i.health<=0&&this.handleAsteroidDestroyed(i,t),t.bounceRemaining>0){const d=(t.x-i.x)/Math.max(1,n),h=(t.y-i.y)/Math.max(1,n),u=t.vx*d+t.vy*h;t.vx=t.vx-2*u*d,t.vy=t.vy-2*u*h,t.bounceRemaining-=1;break}if(t.pierceRemaining>0)t.pierceRemaining--;else if(!t.sticky){this.bulletPool.release(t),this.bullets.splice(e,1);break}}}}for(const e of this.asteroids){const t=l.ASTEROID_SIZES[e.size];if(b(this.playerX,this.playerY,e.x,e.y)<t.radius+l.PLAYER_WIDTH/3){this.eventBus.emit("PLAYER_HIT",{});return}}}splitAsteroid(e){if(e.size==="small")return;const t=e.size==="large"?"medium":"small",s=l.ASTEROID_SIZES[t];for(let i=0;i<2;i++){const a=i===0?-1:1;s.speed*this.speedMultiplier;const n=(2.5+Math.random()*1.5)*a,o=-(1.5+Math.random()*2);this.spawnAsteroid(t,e.x+a*15,e.y,n,o)}}handleExplosion(e,t,s,i){this.particles.emit(e,t,"#ff6600",15,"explosion"),this.triggerScreenShake(.4);for(const a of this.asteroids)b(e,t,a.x,a.y)<i&&(a.health-=s,a.health<=0&&this.handleAsteroidDestroyed(a))}handleChainLightning(e,t,s,i){const a=[];for(let n=0;n<s;n++){let o=null,r=1/0;for(const d of this.asteroids){if(a.includes(d))continue;const h=b(e,t,d.x,d.y);h<150&&h<r&&(r=h,o=d)}if(o){if(!o.active)continue;a.push(o),o.health-=i,o.hitFlash=.15,this.particles.emit(o.x,o.y,"#00ffff",6,"spark"),o.health<=0&&this.handleAsteroidDestroyed(o),e=o.x,t=o.y}}}updateDifficulty(e){this.survivalTime+=e*1e3;const t=Math.min(2,1+Math.floor(this.survivalTime/l.SPEED_INCREASE_INTERVAL)*.05);t!==this.speedMultiplier&&(this.speedMultiplier=t,console.log("[updateDifficulty] Speed multiplier:",this.speedMultiplier));const s=Math.floor(this.survivalTime/l.HEALTH_INCREASE_INTERVAL);s!==this.healthBonus&&(this.healthBonus=s,console.log("[updateDifficulty] Health bonus:",this.healthBonus))}updateBossAnnouncement(e){if(this.bossAnnouncementTimer>0&&(this.bossAnnouncementTimer-=e,this.bossAnnouncementTimer<=0)){const t=document.getElementById("bossAnnouncement");t&&t.classList.remove("active")}}updateBoss(e){if(!this.boss||!this.boss.active)return;const t=g[this.boss.type];if(this.boss.entering){this.boss.y=p(this.boss.y,this.boss.targetY,.03),Math.abs(this.boss.y-this.boss.targetY)<2&&(this.boss.y=this.boss.targetY,this.boss.entering=!1,console.log("[updateBoss] "+t.name+" finished entering, starting attacks"),this.audio.triggerHaptic("heavy"),setTimeout(()=>this.audio.triggerHaptic("heavy"),100),this.triggerScreenShake(12));return}const s={eraser:.3,paperweight:.1,inkblot:.8,rubberband:.5,stapler:.2,scissors:.4};this.boss.rotation+=e*s[this.boss.type],this.boss.pulsePhase+=e*2,this.boss.movePhase+=e,this.updateBossMovement(e),this.boss.isSpecial?this.updateSpecialAbility(e):this.boss.attacksRemaining>0?(this.boss.attackTimer-=e*1e3,this.boss.attackTimer<=0&&(this.bossFireAttack(),this.boss.attacksRemaining--,this.boss.attackTimer=t.attackDelay)):(this.boss.waveTimer-=e*1e3,this.boss.waveTimer<=0&&(this.boss.totalAttacks>0&&Math.floor(this.boss.totalAttacks/t.attacksPerWave)%3===0?this.triggerSpecialAbility():(this.boss.attacksRemaining=t.attacksPerWave,this.boss.waveTimer=t.waveInterval,this.boss.attackTimer=0,console.log("[updateBoss] "+t.name+" starting attack wave"))))}triggerSpecialAbility(){this.boss&&(this.boss.isSpecial=!0,this.boss.specialTimer=3e3,this.boss.phase=0,g[this.boss.type],this.floatingText.add(this.boss.x,this.boss.y-100,"ULTIMATE: "+this.getSpecialName().toUpperCase(),"#ff0000",3),this.audio.triggerHaptic("heavy"))}getSpecialName(){if(!this.boss)return"";switch(this.boss.type){case"eraser":return"Doodle Summon";case"paperweight":return"Seismic Slam";case"inkblot":return"Ink Teleport";case"rubberband":return"The Great Snap";case"stapler":return"Staple Rain";case"scissors":return"Mega Shred";default:return"Overdrive"}}updateSpecialAbility(e){if(!this.boss)return;this.boss.specialTimer-=e*1e3,this.boss.phase+=e;const t=g[this.boss.type];switch(this.boss.type){case"eraser":Math.random()<.1&&this.spawnBossMinion("stick_man",this.boss.x,this.boss.y,{vx:(Math.random()-.5)*10,vy:2+Math.random()*2,health:2});break;case"paperweight":Math.floor(this.boss.phase*5)>Math.floor((this.boss.phase-e)*5)&&(this.spawnBossAreaEffect("shockwave",this.boss.x,this.boss.y,{radius:300,life:1,color:"rgba(100,100,100,0.5)"}),this.triggerScreenShake(5));break;case"inkblot":if(this.boss.specialTimer<1500&&this.boss.specialTimer+e*1e3>=1500){this.particles.emit(this.boss.x,this.boss.y,g.inkblot.color,20,"explosion"),this.boss.x=Math.random()*(this.w-100)+50,this.boss.y=Math.random()*200+100;for(let s=0;s<4;s++)this.spawnBossMinion("ink_spider",this.boss.x,this.boss.y,{health:1})}break;case"rubberband":Math.floor(this.boss.phase*10)>Math.floor((this.boss.phase-e)*10)&&this.spawnBossAreaEffect("gravity_well",this.boss.x,this.boss.y,{radius:400,life:.2,color:"rgba(196,165,116,0.3)"});break;case"stapler":if(Math.random()<.3){this.spawnBossProjectile("staple",{vx:0,vy:6,size:8,color:"#c0c0c0",rotationSpeed:0});const s=this.bossProjectiles[this.bossProjectiles.length-1];s.x=Math.random()*this.w,s.y=-20}break}this.boss.specialTimer<=0&&(this.boss.isSpecial=!1,this.boss.waveTimer=t.waveInterval)}updateBossProjectiles(e){for(let t=this.bossProjectiles.length-1;t>=0;t--){const s=this.bossProjectiles[t];if(!s.active){this.bossProjectiles.splice(t,1);continue}s.age+=e,s.x+=s.vx*e*60,s.y+=s.vy*e*60,s.rotation+=s.rotationSpeed*e*60,s.type==="rubber_band"&&s.stretchPhase!==void 0&&(s.stretchPhase+=e*8),(s.y>this.h+50||s.y<-100||s.x<-50||s.x>this.w+50)&&(s.active=!1)}}checkBossProjectileCollisions(){if(this.damageTimer>0||this.isInvincible)return;const e=15;for(const t of this.bossProjectiles){if(!t.active)continue;if(b(t.x,t.y,this.playerX,this.playerY)<e+t.size){t.active=!1,this.eventBus.emit("PLAYER_HIT"),this.particles.emit(t.x,t.y,t.color,8,"spark"),this.audio.triggerHaptic("error");return}}}updateBossMinions(e){for(let t=this.bossMinions.length-1;t>=0;t--){const s=this.bossMinions[t];if(!s.active){this.bossMinions.splice(t,1);continue}switch(s.timer-=e*1e3,s.type){case"eraser_grunt":if(s.timer<=0){const o=this.playerX-s.x,r=this.playerY-s.y,d=Math.sqrt(o*o+r*r);s.vx=o/d*6,s.vy=r/d*6,s.timer=2e3}s.vx*=.95,s.vy*=.95;break;case"ink_spider":if(s.timer<=0){s.vx=(Math.random()-.5)*4,s.vy=(Math.random()-.5)*4,s.timer=1e3+Math.random()*2e3;for(let o=0;o<4;o++){const r=Math.random()*Math.PI*2;this.spawnBossProjectile("ink_blob",{vx:Math.cos(r)*2,vy:Math.sin(r)*2,size:6,color:g.inkblot.color,rotationSpeed:0})}}break;case"staple_sentry":if(s.timer<=0){s.angle+=.5;const o=4;this.spawnBossProjectile("staple",{vx:Math.cos(s.angle)*o,vy:Math.sin(s.angle)*o,size:8,color:"#c0c0c0",rotationSpeed:0}),s.timer=800}s.vx=0,s.vy=0;break;case"blade_drone":const i=this.playerX-s.x,a=this.playerY-s.y,n=Math.sqrt(i*i+a*a);s.vx=p(s.vx,i/n*3,.05),s.vy=p(s.vy,a/n*3,.05);break;case"stick_man":s.phase||(s.phase=0),s.phase+=e*10,s.timer<=0&&(s.vx=(Math.random()-.5)*8,s.vy=(Math.random()-.5)*4,s.timer=1e3+Math.random()*1e3),Math.random()<.1&&this.particles.emit(s.x,s.y,l.PENCIL_MEDIUM,1,"spark");break}s.x+=s.vx*e*60,s.y+=s.vy*e*60,(s.y>this.h+100||s.y<-200||s.x<-100||s.x>this.w+100)&&(s.active=!1)}}updateBossAreaEffects(e){for(let t=this.bossAreaEffects.length-1;t>=0;t--){const s=this.bossAreaEffects[t];if(s.life-=e,s.life<=0){s.active=!1,this.bossAreaEffects.splice(t,1);continue}const i=b(this.playerX,this.playerY,s.x,s.y);switch(s.type){case"ink_puddle":i<s.radius&&(this.playerVelocityX*=.5,this.playerVelocityY*=.5);break;case"gravity_well":if(i<s.radius){const a=(1-i/s.radius)*5,n=Math.atan2(s.y-this.playerY,s.x-this.playerX);this.playerX+=Math.cos(n)*a,this.playerY+=Math.sin(n)*a}break;case"paper_cut":s.x2!==void 0&&s.y2!==void 0&&this.damageTimer<=0&&!this.isInvincible&&this.distToSegment(this.playerX,this.playerY,s.x,s.y,s.x2,s.y2)<15&&(this.eventBus.emit("PLAYER_HIT"),this.audio.triggerHaptic("error"));break}}}distToSegment(e,t,s,i,a,n){const o=(a-s)**2+(n-i)**2;if(o===0)return b(e,t,s,i);let r=((e-s)*(a-s)+(t-i)*(n-i))/o;return r=Math.max(0,Math.min(1,r)),b(e,t,s+r*(a-s),i+r*(n-i))}checkBossMinionCollisions(){for(let e=this.bullets.length-1;e>=0;e--){const t=this.bullets[e];if(t.active)for(const s of this.bossMinions){if(!s.active)continue;if(b(t.x,t.y,s.x,s.y)<20){s.health-=t.damage,t.active=!1,this.bulletPool.release(t),this.bullets.splice(e,1),s.health<=0&&(s.active=!1,this.particles.emit(s.x,s.y,l.PENCIL_DARK,10,"explosion"),this.score+=500);break}}}if(!(this.damageTimer>0||this.isInvincible))for(const e of this.bossMinions){if(!e.active)continue;if(b(this.playerX,this.playerY,e.x,e.y)<25){this.eventBus.emit("PLAYER_HIT"),this.audio.triggerHaptic("error"),e.active=!1;break}}}updateBossMovement(e){if(!this.boss||this.boss.entering)return;const t=g[this.boss.type],s=2,i=l.BOSS_RADIUS+20;switch(t.movePattern){case"static":this.boss.x=p(this.boss.x,this.w/2,.02);break;case"sway":const a=this.w/2+Math.sin(this.boss.movePhase*.8)*120;this.boss.x=p(this.boss.x,a,.03);break;case"chase":const n=v(this.playerX,i,this.w-i);this.boss.x=p(this.boss.x,n,.015);break;case"bounce":this.boss.vx===0&&(this.boss.vx=s),this.boss.x+=this.boss.vx*e*60,this.boss.x<i?(this.boss.x=i,this.boss.vx=Math.abs(this.boss.vx),this.bossThrowAsteroid(),this.audio.triggerHaptic("medium")):this.boss.x>this.w-i&&(this.boss.x=this.w-i,this.boss.vx=-Math.abs(this.boss.vx),this.bossThrowAsteroid(),this.audio.triggerHaptic("medium"));break;case"zigzag":const r=Math.floor(this.boss.movePhase*2)%2===0?this.w*.25:this.w*.75;this.boss.x=p(this.boss.x,r,.04);break;case"circle":const d=100,h=1.5;this.boss.x=this.w/2+Math.cos(this.boss.movePhase*h)*d,this.boss.y=this.boss.targetY+Math.sin(this.boss.movePhase*h)*(d*.5);break}}bossFireAttack(){if(this.boss){switch(this.boss.totalAttacks++,this.boss.type){case"eraser":this.eraserAttack();break;case"paperweight":this.paperweightAttack();break;case"inkblot":this.inkblotAttack();break;case"rubberband":this.rubberbandAttack();break;case"stapler":this.staplerAttack();break;case"scissors":this.scissorsAttack();break}this.audio.triggerHaptic("light")}}eraserAttack(){if(!this.boss)return;this.boss.totalAttacks%4===0&&(this.spawnBossMinion("eraser_grunt",this.boss.x,this.boss.y,{vx:(Math.random()-.5)*4,vy:2,health:3}),this.floatingText.add(this.boss.x,this.boss.y-20,"ERASER GRUNT!","#f5b5c8",1.5));const e=this.playerX-this.boss.x,t=this.playerY-this.boss.y,s=Math.atan2(t,e),i=2.8+Math.random()*.5,a=s+(Math.random()-.5)*.3;this.spawnBossProjectile("eraser_chunk",{vx:Math.cos(a)*i,vy:Math.sin(a)*i,size:18+Math.random()*8,color:g.eraser.color,rotationSpeed:(Math.random()-.5)*.15})}paperweightAttack(){if(!this.boss)return;this.boss.totalAttacks%5===0&&(this.spawnBossAreaEffect("gravity_well",this.playerX,this.playerY,{radius:120,life:4,color:"rgba(0,0,0,0.5)"}),this.floatingText.add(this.playerX,this.playerY-40,"GRAVITY WELL!","#8b8b8b",1.5));const e=(this.playerX-this.boss.x)*.01;this.spawnBossProjectile("rock",{vx:e+(Math.random()-.5)*.5,vy:2.5+Math.random()*1,size:22+Math.random()*10,color:g.paperweight.color,rotationSpeed:(Math.random()-.5)*.08})}inkblotAttack(){if(!this.boss)return;this.boss.totalAttacks%3===0&&(Math.random()>.5?(this.spawnBossAreaEffect("ink_puddle",this.playerX,this.playerY,{radius:80,life:5,color:g.inkblot.color}),this.floatingText.add(this.playerX,this.playerY-20,"INK PUDDLE!","#2a2a4a",1.5)):(this.spawnBossMinion("ink_spider",this.boss.x,this.boss.y,{health:2}),this.floatingText.add(this.boss.x,this.boss.y-20,"INK SPIDER!","#2a2a4a",1.5)));const e=this.playerX-this.boss.x,t=this.playerY-this.boss.y,s=Math.atan2(t,e),i=3.2;for(let a=-1;a<=1;a++){const n=s+a*.35;this.spawnBossProjectile("ink_blob",{vx:Math.cos(n)*i,vy:Math.sin(n)*i,size:12+Math.random()*6,color:g.inkblot.color,rotationSpeed:0})}}rubberbandAttack(){if(!this.boss)return;this.boss.totalAttacks%4===0&&(this.bossThrowAsteroid(),this.bossThrowAsteroid());const e=this.playerX-this.boss.x,t=this.playerY-this.boss.y,s=Math.atan2(t,e),i=3.5,a=this.boss.totalAttacks%8*.4,n=s+Math.sin(a)*.5,o=this.spawnBossProjectile("rubber_band",{vx:Math.cos(n)*i,vy:Math.sin(n)*i,size:20,color:g.rubberband.color,rotationSpeed:.1});o&&(o.stretchPhase=0)}staplerAttack(){if(!this.boss)return;this.boss.totalAttacks%10===0&&(this.spawnBossMinion("staple_sentry",this.boss.x+(Math.random()-.5)*200,100,{health:10,angle:Math.random()*Math.PI*2}),this.floatingText.add(this.boss.x,this.boss.y-20,"STAPLE SENTRY!","#4a4a4a",1.5));const e=this.playerX-this.boss.x,t=this.playerY-this.boss.y,s=Math.atan2(t,e),i=5,a=Math.sin(this.boss.totalAttacks*.5)*.15,n=s+a;this.spawnBossProjectile("staple",{vx:Math.cos(n)*i,vy:Math.sin(n)*i,size:8,color:"#c0c0c0",rotationSpeed:0})}scissorsAttack(){if(!this.boss)return;if(this.boss.totalAttacks%4===0)if(Math.random()>.5)this.spawnBossMinion("blade_drone",this.boss.x,this.boss.y,{health:5}),this.floatingText.add(this.boss.x,this.boss.y-20,"BLADE DRONE!","#c0c0c0",1.5);else{const d=Math.random()>.5?0:this.w,h=Math.random()*this.h,u=this.w-d,c=this.h-h;this.spawnBossAreaEffect("paper_cut",d,h,{x2:u,y2:c,life:3,color:"#ff6600"}),this.floatingText.add(this.w/2,this.h/2,"PAPER CUT!","#ff6600",2)}const e=this.playerX-this.boss.x,t=this.playerY-this.boss.y,s=Math.atan2(t,e),i=3.8,a=s-.4,n=s+.4,o=this.spawnBossProjectile("blade",{vx:Math.cos(a)*i,vy:Math.sin(a)*i,size:25,color:g.scissors.color,rotationSpeed:.12});o&&(o.bladeAngle=a);const r=this.spawnBossProjectile("blade",{vx:Math.cos(n)*i,vy:Math.sin(n)*i,size:25,color:g.scissors.color,rotationSpeed:-.12});r&&(r.bladeAngle=n)}spawnBossMinion(e,t,s,i={}){const a={id:++this.bossMinionIdCounter,type:e,x:t,y:s,vx:i.vx??0,vy:i.vy??0,health:i.health??5,maxHealth:i.health??5,active:!0,timer:0,angle:i.angle??0};return this.bossMinions.push(a),a}spawnBossAreaEffect(e,t,s,i={}){const a={id:++this.bossAreaEffectIdCounter,type:e,x:t,y:s,x2:i.x2,y2:i.y2,radius:i.radius??50,life:i.life??3,maxLife:i.life??3,active:!0,color:i.color??"rgba(0,0,0,0.2)"};return this.bossAreaEffects.push(a),a}spawnBossProjectile(e,t){if(!this.boss)return null;const s={id:++this.bossProjectileIdCounter,type:e,x:this.boss.x,y:this.boss.y+l.BOSS_RADIUS*.6,vx:t.vx,vy:t.vy,rotation:Math.random()*Math.PI*2,rotationSpeed:t.rotationSpeed,size:t.size,damage:1,active:!0,age:0,color:t.color};return this.bossProjectiles.push(s),s}bossThrowAsteroid(){if(!this.boss)return;const e=this.playerX-this.boss.x,t=this.playerY-this.boss.y,s=Math.sqrt(e*e+t*t),i=3;this.spawnBossAsteroid(e/s*i,t/s*i)}spawnBossAsteroid(e,t){if(!this.boss)return;const s=this.asteroidPool.acquire();s&&(s.id=++this.asteroidIdCounter,s.size="large",s.maxHealth=l.BOSS_ASTEROID_HEALTH,s.health=l.BOSS_ASTEROID_HEALTH,s.x=this.boss.x,s.y=this.boss.y+l.BOSS_RADIUS*.8,s.vx=e,s.vy=t,s.rotation=Math.random()*Math.PI*2,s.rotationSpeed=T(-2,2),s.active=!0,s.hitFlash=0,s.isBossAsteroid=!0,this.asteroids.push(s))}drawBossProjectiles(){const e=this.ctx;for(const t of this.bossProjectiles)if(t.active){switch(e.save(),e.translate(t.x,t.y),e.rotate(t.rotation),t.type){case"eraser_chunk":e.fillStyle=t.color,e.strokeStyle=g.eraser.accentColor,e.lineWidth=2,e.beginPath(),e.roundRect(-t.size/2,-t.size/3,t.size,t.size*.6,4),e.fill(),e.stroke();break;case"rock":e.fillStyle=t.color,e.strokeStyle=l.PENCIL_DARK,e.lineWidth=2,e.beginPath();const s=6;for(let n=0;n<=s;n++){const o=n/s*Math.PI*2,r=t.size*(.8+Math.sin(n*2.3)*.2);n===0?e.moveTo(Math.cos(o)*r,Math.sin(o)*r):e.lineTo(Math.cos(o)*r,Math.sin(o)*r)}e.closePath(),e.fill(),e.stroke();break;case"ink_blob":e.fillStyle=t.color,e.beginPath();const i=8;for(let n=0;n<=i;n++){const o=n/i*Math.PI*2,r=Math.sin(t.age*10+n*1.5)*3,d=t.size+r;n===0?e.moveTo(Math.cos(o)*d,Math.sin(o)*d):e.lineTo(Math.cos(o)*d,Math.sin(o)*d)}e.closePath(),e.fill(),e.beginPath(),e.ellipse(0,t.size,t.size*.3,t.size*.5,0,0,Math.PI*2),e.fill();break;case"rubber_band":const a=1+Math.sin(t.stretchPhase||0)*.3;e.strokeStyle=t.color,e.lineWidth=4,e.lineCap="round",e.beginPath(),e.ellipse(0,0,t.size*a,t.size/a,0,0,Math.PI*2),e.stroke(),e.strokeStyle=g.rubberband.accentColor,e.lineWidth=2,e.beginPath(),e.ellipse(0,0,t.size*a*.7,t.size/a*.7,0,0,Math.PI*2),e.stroke();break;case"staple":e.strokeStyle=t.color,e.lineWidth=3,e.lineCap="square",e.beginPath(),e.moveTo(-t.size,-t.size/2),e.lineTo(-t.size,t.size/2),e.lineTo(t.size,t.size/2),e.lineTo(t.size,-t.size/2),e.stroke();break;case"blade":e.fillStyle=t.color,e.strokeStyle=l.PENCIL_DARK,e.lineWidth=1,e.beginPath(),e.moveTo(-t.size,0),e.lineTo(0,-t.size*.3),e.lineTo(t.size,0),e.lineTo(0,t.size*.3),e.closePath(),e.fill(),e.stroke(),e.strokeStyle="#ffffff",e.lineWidth=1,e.beginPath(),e.moveTo(-t.size*.8,-t.size*.1),e.lineTo(t.size*.5,-t.size*.1),e.stroke();break}e.restore()}}drawBossMinions(){const e=this.ctx;for(const t of this.bossMinions)if(t.active){switch(e.save(),e.translate(t.x,t.y),e.rotate(t.angle),t.type){case"eraser_grunt":e.fillStyle=g.eraser.color,e.strokeStyle=g.eraser.accentColor,e.lineWidth=2,e.beginPath(),e.roundRect(-15,-10,30,20,5),e.fill(),e.stroke(),e.fillStyle="white",e.fillRect(-8,-5,4,4),e.fillRect(4,-5,4,4);break;case"ink_spider":e.fillStyle=g.inkblot.color,e.beginPath(),e.arc(0,0,12,0,Math.PI*2),e.fill(),e.strokeStyle=g.inkblot.color,e.lineWidth=2;for(let i=0;i<6;i++){const a=i/6*Math.PI*2+this.survivalTime*.01;e.beginPath(),e.moveTo(0,0),e.lineTo(Math.cos(a)*20,Math.sin(a)*20),e.stroke()}break;case"staple_sentry":e.fillStyle="#4a4a4a",e.strokeStyle="#2d2d2d",e.lineWidth=2,e.beginPath(),e.roundRect(-12,-12,24,24,3),e.fill(),e.stroke(),e.fillStyle="#ff4444",e.beginPath(),e.arc(0,0,5,0,Math.PI*2),e.fill();break;case"blade_drone":e.fillStyle="#c0c0c0",e.strokeStyle="#2d2d2d",e.lineWidth=2,e.beginPath(),e.moveTo(-20,0),e.lineTo(0,-10),e.lineTo(20,0),e.lineTo(0,10),e.closePath(),e.fill(),e.stroke(),e.strokeStyle="rgba(0,0,0,0.3)",e.beginPath(),e.ellipse(0,0,25,5,this.survivalTime*.02,0,Math.PI*2),e.stroke();break;case"stick_man":e.strokeStyle=l.PENCIL_DARK,e.lineWidth=2;const s=Math.sin(t.phase||0)*10;e.beginPath(),e.arc(0,-25,6,0,Math.PI*2),e.stroke(),e.beginPath(),e.moveTo(0,-19),e.lineTo(0,-5),e.stroke(),e.beginPath(),e.moveTo(0,-5),e.lineTo(-s,10),e.moveTo(0,-5),e.lineTo(s,10),e.stroke(),e.beginPath(),e.moveTo(0,-15),e.lineTo(-10,-10+s/2),e.moveTo(0,-15),e.lineTo(10,-10-s/2),e.stroke();break}e.restore()}}drawBossAreaEffects(){const e=this.ctx;for(const t of this.bossAreaEffects){if(!t.active)continue;e.save();const s=Math.min(1,t.life/.5)*.4;switch(e.globalAlpha=s,t.type){case"ink_puddle":e.fillStyle=t.color,e.beginPath();for(let n=0;n<12;n++){const o=n/12*Math.PI*2,r=t.radius*(.8+Math.sin(n*1.7)*.2);n===0?e.moveTo(t.x+Math.cos(o)*r,t.y+Math.sin(o)*r):e.lineTo(t.x+Math.cos(o)*r,t.y+Math.sin(o)*r)}e.closePath(),e.fill();break;case"gravity_well":const i=e.createRadialGradient(t.x,t.y,0,t.x,t.y,t.radius);i.addColorStop(0,"rgba(0,0,0,0.8)"),i.addColorStop(1,"transparent"),e.fillStyle=i,e.beginPath(),e.arc(t.x,t.y,t.radius,0,Math.PI*2),e.fill(),e.strokeStyle="white",e.lineWidth=1;for(let n=0;n<3;n++)e.beginPath(),e.arc(t.x,t.y,t.radius*(.3+n*.2),this.survivalTime*.005+n,this.survivalTime*.005+n+2),e.stroke();break;case"paper_cut":t.x2!==void 0&&t.y2!==void 0&&(e.strokeStyle=t.color,e.lineWidth=2,e.setLineDash([10,5]),e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(t.x2,t.y2),e.stroke(),e.setLineDash([]),t.life>t.maxLife-.2&&(e.globalAlpha=1,e.strokeStyle="white",e.lineWidth=4,e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(t.x2,t.y2),e.stroke()));break;case"shockwave":e.strokeStyle=t.color,e.lineWidth=3;const a=(1-t.life/t.maxLife)*t.radius;e.beginPath(),e.arc(t.x,t.y,a,0,Math.PI*2),e.stroke();break}e.restore()}}checkBossCollisions(){if(!(!this.boss||!this.boss.active||this.boss.entering))for(let e=this.bullets.length-1;e>=0;e--){const t=this.bullets[e];if(!t.active)continue;if(b(t.x,t.y,this.boss.x,this.boss.y)<l.BOSS_RADIUS){const i=t.snowball?1+Math.min(1,t.age/1.2)*(t.snowballMax-1):1,a=t.damage*i;t.active=!1,this.bulletPool.release(t),this.bullets.splice(e,1),this.boss.health-=a,this.particles.emit(t.x,t.y,l.PENCIL_DARK,5,"spark"),this.audio.playHit(),this.triggerScreenShake(2),console.log("[checkBossCollisions] Boss hit! Health:",this.boss.health),this.boss.health<=0&&this.defeatBoss()}}}defeatBoss(){if(!this.boss)return;const e=this.bossesDefeated+1;console.log("[defeatBoss] Boss #"+e+" defeated!"),this.particles.emit(this.boss.x,this.boss.y,l.PENCIL_DARK,30+e*5,"explosion"),this.particles.emit(this.boss.x,this.boss.y,"#ff6644",20+e*3,"spark"),this.particles.emit(this.boss.x,this.boss.y,l.PAPER_BG,25+e*4,"paper");const t=250*e,s=1e4*e;this.coins+=t,this.score+=s+t*10,this.floatingText.add(this.boss.x-40,this.boss.y,"+"+t+" COINS","#ffd700",30),this.floatingText.add(this.boss.x+40,this.boss.y-30,"+"+s+" POINTS","#ff4444",40);for(let i=0;i<5;i++)setTimeout(()=>{this.boss&&this.floatingText.add(this.boss.x+(Math.random()-.5)*200,this.boss.y+(Math.random()-.5)*200,"JACKPOT!","#ffcc00",25)},i*200);this.boss.active=!1,this.boss.defeated=!0,this.bossesDefeated,this.bossesDefeated++,this.asteroids.forEach(i=>{i.isBossAsteroid&&(i.active=!1)}),this.bossProjectiles=[],this.audio.playUpgrade(),this.audio.triggerHaptic("success"),this.triggerScreenShake(15),setTimeout(()=>{console.log("[defeatBoss] Boss #"+e+" - showing tier "+e+" ability selection"),this.showAbilityScreen(e)},1500)}generateDoodles(){this.bgDoodles=[];const e=["!","??","*","+","=","hello!","PE","maths...","???","( )","Paper Plane","BOOM!","A+","100%","Nice!","Cool","X","O","V","POWER","FLY","CLOUD","Doodle","Paper","Ink"];for(let t=0;t<25;t++)this.bgDoodles.push({x:Math.random()*this.w,y:Math.random()*this.h,text:e[Math.floor(Math.random()*e.length)],scale:.4+Math.random()*1.6,rotation:(Math.random()-.5)*.8,speed:15+Math.random()*45})}drawBackground(){const e=this.ctx;e.fillStyle=l.PAPER_BG,e.fillRect(0,0,this.w,this.h),this.bgOffset=(this.bgOffset+l.BACKGROUND_SCROLL_SPEED*.016)%l.GRID_SIZE,e.strokeStyle=l.GRID_LINE,e.lineWidth=1;for(let t=0;t<this.w;t+=l.GRID_SIZE)e.beginPath(),e.moveTo(t,0),e.lineTo(t,this.h),e.stroke();for(let t=this.bgOffset;t<this.h+l.GRID_SIZE;t+=l.GRID_SIZE)e.beginPath(),e.moveTo(0,t),e.lineTo(this.w,t),e.stroke();e.strokeStyle="#ffaaaa",e.lineWidth=2,e.beginPath(),e.moveTo(60,0),e.lineTo(60,this.h),e.stroke(),e.fillStyle="rgba(45, 45, 45, 0.08)",e.font="bold 24px 'Caveat', cursive",this.bgDoodles.forEach(t=>{t.y+=t.speed*.016,t.y>this.h+50&&(t.y=-50,t.x=Math.random()*this.w),e.save(),e.translate(t.x,t.y),e.rotate(t.rotation),e.scale(t.scale,t.scale),e.fillText(t.text,0,0),e.restore()})}drawPlayer(){const e=this.ctx,t=this.playerX,s=this.playerY;if(this.isInvincible&&Math.floor(this.damageFlashTimer)%2===1)return;if(e.save(),e.translate(t,s),e.rotate(this.playerTilt),e.scale(this.playerScaleX,this.playerScaleY),this.spinDirection!==0){const a=Math.cos(this.spinAngle);e.scale(a,1)}const i=this.isInvincible?.7:1;e.globalAlpha=i,e.strokeStyle=this.isInvincible?"#ff6666":l.PENCIL_DARK,e.lineWidth=2.5,e.lineCap="round",e.lineJoin="round",e.fillStyle=this.isInvincible?"#ffcccc":"#ffffff",e.shadowColor="rgba(0,0,0,0.1)",e.shadowBlur=10,e.shadowOffsetY=15,this.selectedPlane==="dart"?(e.beginPath(),e.moveTo(0,-32),e.lineTo(-22,28),e.lineTo(0,18),e.lineTo(22,28),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.moveTo(0,-32),e.lineTo(0,18),e.stroke(),e.lineWidth=1,e.beginPath(),e.moveTo(-10,5),e.lineTo(-18,20),e.stroke(),e.beginPath(),e.moveTo(10,5),e.lineTo(18,20),e.stroke()):this.selectedPlane==="glider"?(e.beginPath(),e.moveTo(0,-28),e.lineTo(-38,22),e.lineTo(-28,28),e.lineTo(0,12),e.lineTo(28,28),e.lineTo(38,22),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.moveTo(-20,24),e.lineTo(0,-22),e.lineTo(20,24),e.stroke()):(e.beginPath(),e.moveTo(0,-22),e.lineTo(-28,18),e.lineTo(-22,28),e.lineTo(0,22),e.lineTo(22,28),e.lineTo(28,18),e.closePath(),e.fill(),e.stroke(),e.fillStyle="#f8f8f8",e.beginPath(),e.moveTo(-10,-18),e.lineTo(10,-18),e.lineTo(12,22),e.lineTo(-12,22),e.closePath(),e.fill(),e.stroke()),e.restore()}drawDrones(){if(this.drones.length===0)return;const e=this.ctx;for(const t of this.drones)e.save(),e.translate(t.x,t.y),e.rotate(t.facingAngle+Math.PI/2),e.strokeStyle=l.PENCIL_DARK,e.lineWidth=1.5,e.fillStyle="#f0f0f0",e.beginPath(),e.moveTo(0,-10),e.lineTo(-8,8),e.lineTo(0,4),e.lineTo(8,8),e.closePath(),e.fill(),e.stroke(),e.restore()}drawBullets(){const e=this.ctx;for(const t of this.bullets){if(e.save(),e.translate(t.x,t.y),e.rotate(Math.atan2(t.vy,t.vx)+Math.PI/2),t.shape==="note")e.fillStyle="#3b2f2f",e.strokeStyle=l.PENCIL_DARK,e.lineWidth=2,e.beginPath(),e.ellipse(0,6,5*t.size,4*t.size,.2,0,Math.PI*2),e.fill(),e.stroke(),e.beginPath(),e.moveTo(3,-14*t.size),e.lineTo(3,2*t.size),e.stroke(),e.beginPath(),e.arc(6,-14*t.size,4*t.size,Math.PI,Math.PI*1.6),e.stroke();else if(t.shape==="star"){e.fillStyle=t.color,e.strokeStyle=l.PENCIL_DARK,e.lineWidth=2,e.beginPath();for(let s=0;s<5;s++){const i=s*2*Math.PI/5-Math.PI/2,a=8*t.size,n=4*t.size,o=Math.cos(i)*a,r=Math.sin(i)*a,d=Math.cos(i+Math.PI/5)*n,h=Math.sin(i+Math.PI/5)*n;s===0?e.moveTo(o,r):e.lineTo(o,r),e.lineTo(d,h)}e.closePath(),e.fill(),e.stroke()}else t.shape==="bolt"?(e.strokeStyle=t.color,e.lineWidth=3,e.lineCap="round",e.beginPath(),e.moveTo(-4,-10),e.lineTo(2,-2),e.lineTo(-2,2),e.lineTo(4,10),e.stroke()):t.shape==="rocket"?(e.fillStyle=t.color,e.strokeStyle=l.PENCIL_DARK,e.lineWidth=2,e.beginPath(),e.moveTo(0,-12*t.size),e.lineTo(-5*t.size,8*t.size),e.lineTo(5*t.size,8*t.size),e.closePath(),e.fill(),e.stroke(),e.fillStyle="#ffcc66",e.beginPath(),e.moveTo(0,10*t.size),e.lineTo(-3*t.size,15*t.size),e.lineTo(3*t.size,15*t.size),e.closePath(),e.fill()):t.shape==="bubble"?(e.strokeStyle=t.color,e.lineWidth=2,e.beginPath(),e.arc(0,0,8*t.size,0,Math.PI*2),e.stroke(),e.beginPath(),e.arc(3*t.size,-4*t.size,2*t.size,0,Math.PI*2),e.stroke()):(e.strokeStyle=t.color,e.lineWidth=t.fromDrone?2:3,e.lineCap="round",e.beginPath(),e.moveTo(t.jitterOffset*.5,-10*t.size),e.lineTo(-t.jitterOffset*.5,10*t.size),e.stroke());e.restore()}}drawAsteroids(){const e=this.ctx;for(const t of this.asteroids){const s=l.ASTEROID_SIZES[t.size];e.save(),e.translate(t.x,t.y),e.rotate(t.rotation);const i=1+(t.hitFlash>0?t.hitFlash*.5:0);e.scale(i,i),e.fillStyle="#ffffff",e.strokeStyle=l.PENCIL_DARK,e.lineWidth=2.5,e.lineJoin="round",e.beginPath();const a=10;for(let n=0;n<a;n++){const o=n/a*Math.PI*2,r=.8+Math.sin(t.id*1.5+n*2.3)*.25,d=s.radius*r;n===0?e.moveTo(Math.cos(o)*d,Math.sin(o)*d):e.lineTo(Math.cos(o)*d,Math.sin(o)*d)}e.closePath(),e.shadowColor="rgba(0,0,0,0.05)",e.shadowBlur=5,e.shadowOffsetY=8,e.fill(),e.stroke(),e.strokeStyle="rgba(45, 45, 45, 0.15)",e.lineWidth=1.5;for(let n=0;n<4;n++){const o=(t.id*1.2+n*1.5)%(Math.PI*2),r=s.radius*(.2+Math.sin(t.id+n)*.1),d=s.radius*(.6+Math.cos(t.id*2+n)*.2);e.beginPath(),e.moveTo(Math.cos(o)*r,Math.sin(o)*r),e.lineTo(Math.cos(o+.5)*d,Math.sin(o+.5)*d),e.stroke()}e.rotate(-t.rotation),e.font="bold "+s.radius*.7+"px 'Caveat', cursive",e.textAlign="center",e.textBaseline="middle",e.fillStyle="rgba(45, 45, 45, 0.8)",e.fillText(t.health.toString(),0,2),e.restore()}}initDemoAnimation(){if(!this.demoCanvas)return;console.log("[initDemoAnimation]");const e=this.demoCanvas.parentElement;e&&(this.demoCanvas.width=e.clientWidth,this.demoCanvas.height=e.clientHeight),this.demoPlaneX=this.demoCanvas.width/2,this.demoPlaneY=this.demoCanvas.height-35,this.demoPlaneTargetX=this.demoPlaneX,this.demoPlaneDirection=1,this.demoBullets=[],this.demoAsteroids=[],this.demoParticles=[]}updateDemoAnimation(e){if(!this.demoCanvas||!this.demoCtx)return;const t=this.demoCanvas.width,s=this.demoCanvas.height;this.demoBgOffset=(this.demoBgOffset+30*e)%25,Math.random()<.02&&(this.demoPlaneTargetX=40+Math.random()*(t-80)),this.demoPlaneX=p(this.demoPlaneX,this.demoPlaneTargetX,.05),this.demoFireTimer-=e*1e3,this.demoFireTimer<=0&&(this.demoBullets.push({x:this.demoPlaneX,y:this.demoPlaneY-15,vy:-6,active:!0}),this.demoFireTimer=200),this.demoSpawnTimer-=e*1e3,this.demoSpawnTimer<=0&&(this.demoAsteroids.push({x:30+Math.random()*(t-60),y:-25,vx:(Math.random()-.5)*2,vy:1.8+Math.random()*1.2,radius:18+Math.random()*12,rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.05,health:2,active:!0}),this.demoSpawnTimer=800+Math.random()*400);for(let i=this.demoBullets.length-1;i>=0;i--){const a=this.demoBullets[i];a.y+=a.vy,a.y<-10&&this.demoBullets.splice(i,1)}for(let i=this.demoAsteroids.length-1;i>=0;i--){const a=this.demoAsteroids[i];a.x+=a.vx,a.y+=a.vy,a.rotation+=a.rotationSpeed,a.x-a.radius<0?(a.x=a.radius,a.vx=Math.abs(a.vx)):a.x+a.radius>t&&(a.x=t-a.radius,a.vx=-Math.abs(a.vx)),a.y>s+30&&this.demoAsteroids.splice(i,1)}for(let i=this.demoParticles.length-1;i>=0;i--){const a=this.demoParticles[i];a.x+=a.vx,a.y+=a.vy,a.vy+=.15,a.life-=.04,a.life<=0&&this.demoParticles.splice(i,1)}for(let i=this.demoBullets.length-1;i>=0;i--){const a=this.demoBullets[i];for(let n=this.demoAsteroids.length-1;n>=0;n--){const o=this.demoAsteroids[n];if(Math.sqrt((a.x-o.x)**2+(a.y-o.y)**2)<o.radius+4){if(o.health--,this.demoBullets.splice(i,1),o.health<=0){for(let d=0;d<6;d++){const h=Math.random()*Math.PI*2,u=1+Math.random()*2;this.demoParticles.push({x:o.x,y:o.y,vx:Math.cos(h)*u,vy:Math.sin(h)*u,life:1,size:3+Math.random()*4})}this.demoAsteroids.splice(n,1)}break}}}}renderDemoAnimation(){if(!this.demoCanvas||!this.demoCtx)return;const e=this.demoCtx,t=this.demoCanvas.width,s=this.demoCanvas.height;e.fillStyle="#f5f5dc",e.fillRect(0,0,t,s),e.strokeStyle="#d4d4c4",e.lineWidth=1;for(let a=0;a<t;a+=25)e.beginPath(),e.moveTo(a,0),e.lineTo(a,s),e.stroke();for(let a=this.demoBgOffset;a<s+25;a+=25)e.beginPath(),e.moveTo(0,a),e.lineTo(t,a),e.stroke();for(const a of this.demoAsteroids){e.save(),e.translate(a.x,a.y),e.rotate(a.rotation),e.fillStyle="#e8e8e0",e.strokeStyle="#2d2d2d",e.lineWidth=1.5,e.beginPath();for(let n=0;n<6;n++){const o=n/6*Math.PI*2,r=.85+Math.sin(n*47)*.2,d=a.radius*r;n===0?e.moveTo(Math.cos(o)*d,Math.sin(o)*d):e.lineTo(Math.cos(o)*d,Math.sin(o)*d)}e.closePath(),e.fill(),e.stroke(),e.restore()}e.strokeStyle="#2d2d2d",e.lineWidth=2,e.lineCap="round";for(const a of this.demoBullets)e.beginPath(),e.moveTo(a.x,a.y-6),e.lineTo(a.x,a.y+6),e.stroke();for(const a of this.demoParticles)e.globalAlpha=a.life,e.fillStyle="#2d2d2d",e.beginPath(),e.arc(a.x,a.y,a.size*a.life,0,Math.PI*2),e.fill();e.globalAlpha=1,e.save(),e.translate(this.demoPlaneX,this.demoPlaneY);const i=(this.demoPlaneTargetX-this.demoPlaneX)*.015;e.rotate(v(i,-.25,.25)),e.strokeStyle="#2d2d2d",e.lineWidth=1.5,e.fillStyle="#ffffff",e.beginPath(),e.moveTo(0,-18),e.lineTo(-12,14),e.lineTo(0,8),e.lineTo(12,14),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.moveTo(0,-18),e.lineTo(0,8),e.stroke(),e.restore()}gameLoop(e){const t=Math.min((e-this.lastTime)/1e3,.1);this.lastTime=e,this.update(t),this.render(),this.gameState==="START"&&(this.updateDemoAnimation(t),this.renderDemoAnimation()),requestAnimationFrame(s=>this.gameLoop(s))}update(e){if(this.screenShake.intensity>0&&(this.screenShake.x=(Math.random()-.5)*this.screenShake.intensity*15,this.screenShake.y=(Math.random()-.5)*this.screenShake.intensity*15,this.screenShake.intensity*=.9,this.screenShake.intensity<.01&&(this.screenShake.intensity=0,this.screenShake.x=0,this.screenShake.y=0)),this.particles.update(e),this.floatingText.update(e),this.gameState==="PLAYING"){this.updatePlayer(e),this.updateAbilities(e),this.updateDamageState(e),this.updateDrones(e),this.updateBullets(e),this.updateAsteroids(e),this.checkCollisions(),this.updateDifficulty(e);const t=this.currentStats.fireRateMs;this.fireTimer-=e*1e3,this.fireTimer<=0&&(this.fireBullets(),this.fireTimer=t);const s=Math.pow(.95,this.bossesDefeated),i=Math.max(l.SPAWN_INTERVAL_MIN*s,(l.SPAWN_INTERVAL_START-this.survivalTime*.02)*s);this.spawnTimer-=e*1e3,this.spawnTimer<=0&&(this.spawnAsteroid(),this.spawnTimer=i),this.updateHUD()}else if(this.gameState!=="ABILITY_CHOICE"){if(this.gameState!=="UPGRADE"){if(this.gameState==="BOSS"){this.updateBossAnnouncement(e),this.updatePlayer(e),this.updateAbilities(e),this.updateDamageState(e),this.updateDrones(e),this.updateBullets(e),this.updateAsteroids(e),this.updateBoss(e),this.updateBossProjectiles(e),this.updateBossMinions(e),this.updateBossAreaEffects(e),this.checkBossCollisions(),this.checkBossProjectileCollisions(),this.checkBossMinionCollisions(),this.checkCollisions();const t=this.currentStats.fireRateMs;this.fireTimer-=e*1e3,this.fireTimer<=0&&(this.fireBullets(),this.fireTimer=t),this.updateHUD()}}}}render(){const e=this.ctx;e.save(),e.translate(this.screenShake.x,this.screenShake.y),this.drawBackground(),(this.gameState==="PLAYING"||this.gameState==="PAUSED"||this.gameState==="UPGRADE"||this.gameState==="ABILITY_CHOICE"||this.gameState==="GAME_OVER"||this.gameState==="BOSS")&&(this.drawAsteroids(),this.drawBullets(),this.drawDrones(),this.drawOrbitals(),this.drawPlayer(),this.particles.draw(e),this.floatingText.draw(e),this.gameState==="BOSS"&&(this.drawBossAreaEffects(),this.drawBossProjectiles(),this.drawBossMinions(),this.boss&&this.boss.active&&this.drawBoss())),e.restore()}drawBoss(){if(!this.boss)return;const e=this.ctx,t=this.boss.x,s=this.boss.y,i=l.BOSS_RADIUS,a=1+Math.sin(this.boss.pulsePhase)*.03,n=i*a,o=g[this.boss.type];switch(e.save(),e.translate(t,s),this.boss.type){case"eraser":this.drawEraserBoss(e,n,o);break;case"paperweight":this.drawPaperweightBoss(e,n,o);break;case"inkblot":this.drawInkblotBoss(e,n,o);break;case"rubberband":this.drawRubberbandBoss(e,n,o);break;case"stapler":this.drawStaplerBoss(e,n,o);break;case"scissors":this.drawScissorsBoss(e,n,o);break}e.restore(),this.drawBossHealthBar(t,s-n-25),e.save(),e.font="bold 14px "+l.FONT_FAMILY,e.fillStyle=l.PENCIL_DARK,e.textAlign="center",e.fillText(o.name,t,s-n-45),e.restore()}drawEraserBoss(e,t,s){e.rotate(this.boss.rotation*.3);const i=t*1.8,a=t*.9;e.beginPath(),e.roundRect(-i/2,-a/2,i,a,15),e.fillStyle=s.color,e.fill(),e.strokeStyle=s.accentColor,e.lineWidth=3,e.stroke(),e.fillStyle="#5588cc",e.beginPath(),e.roundRect(-i/2,-a/2,i*.2,a,[15,0,0,15]),e.fill(),e.strokeStyle=l.PENCIL_MEDIUM,e.lineWidth=1.5;for(let n=0;n<5;n++){const o=-i/4+n*15,r=-5+Math.sin(n*2+this.boss.pulsePhase)*3;e.beginPath(),e.moveTo(o,r),e.lineTo(o+8,r+4),e.stroke()}this.drawBossEyes(e,-15,-5,15,5)}drawPaperweightBoss(e,t,s){e.beginPath(),e.ellipse(0,10,t*1.1,t*.7,0,0,Math.PI*2),e.fillStyle=s.color,e.fill(),e.strokeStyle=l.PENCIL_DARK,e.lineWidth=4,e.stroke(),e.beginPath(),e.ellipse(0,-15,t*.8,t*.6,0,Math.PI,Math.PI*2),e.fillStyle="#9a9a9a",e.fill(),e.stroke(),e.strokeStyle=s.accentColor,e.lineWidth=2;const i=[[-30,0,-10,20],[20,-10,35,15],[-15,25,15,35],[0,-25,10,-5]];for(const[a,n,o,r]of i)e.beginPath(),e.moveTo(a,n),e.lineTo(o,r),e.stroke();this.drawBossEyes(e,-20,-5,20,-5)}drawInkblotBoss(e,t,s){e.rotate(this.boss.rotation),e.beginPath();const i=20;for(let a=0;a<=i;a++){const n=a/i*Math.PI*2,o=Math.sin(n*5+this.boss.pulsePhase*3)*15,r=t*.9+o,d=Math.cos(n)*r,h=Math.sin(n)*r;a===0?e.moveTo(d,h):e.lineTo(d,h)}e.closePath(),e.fillStyle=s.color,e.fill(),e.fillStyle=s.accentColor;for(let a=0;a<4;a++){const n=-40+a*25,o=t*.5+Math.sin(this.boss.pulsePhase+a)*10;e.beginPath(),e.ellipse(n,o,8,15+Math.sin(this.boss.pulsePhase+a*2)*5,0,0,Math.PI*2),e.fill()}e.fillStyle="#ffffff",e.beginPath(),e.ellipse(-18,-10,12,10,0,0,Math.PI*2),e.ellipse(18,-10,12,10,0,0,Math.PI*2),e.fill(),e.fillStyle="#ff0000",e.beginPath(),e.arc(-18,-8,5,0,Math.PI*2),e.arc(18,-8,5,0,Math.PI*2),e.fill()}drawRubberbandBoss(e,t,s){e.rotate(this.boss.rotation);const i=12;for(let a=0;a<3;a++){e.strokeStyle=a%2===0?s.color:s.accentColor,e.lineWidth=6-a;for(let n=0;n<i;n++){const o=n/i*Math.PI+a*.3;e.beginPath(),e.ellipse(0,0,t*(.9-a*.15),t*(.6-a*.1),o,0,Math.PI*2),e.stroke()}}e.beginPath(),e.arc(0,0,25,0,Math.PI*2),e.fillStyle="#654321",e.fill(),this.drawBossEyes(e,-8,-5,8,-5,.5)}drawStaplerBoss(e,t,s){const i=t*2,a=t*.6;e.fillStyle=s.color,e.beginPath(),e.roundRect(-i/2,0,i,a,5),e.fill(),e.strokeStyle=l.PENCIL_DARK,e.lineWidth=3,e.stroke();const n=Math.sin(this.boss.pulsePhase*2)*.15;e.save(),e.rotate(n),e.fillStyle=s.accentColor,e.beginPath(),e.roundRect(-i/2+10,-a*.8,i-20,a*.7,5),e.fill(),e.strokeStyle=l.PENCIL_DARK,e.lineWidth=2,e.stroke(),e.restore(),e.fillStyle="#c0c0c0",e.fillRect(-10,a-5,20,10),e.save(),e.rotate(n),this.drawBossEyes(e,-25,-a*.4,25,-a*.4),e.restore()}drawScissorsBoss(e,t,s){const i=.3+Math.abs(Math.sin(this.boss.pulsePhase*2))*.4;e.save(),e.rotate(-i),e.beginPath(),e.moveTo(0,0),e.lineTo(-t*1.5,-30),e.lineTo(-t*1.4,0),e.lineTo(-t*1.5,30),e.closePath(),e.fillStyle=s.color,e.fill(),e.strokeStyle=l.PENCIL_DARK,e.lineWidth=2,e.stroke(),e.strokeStyle="#ffffff",e.lineWidth=1,e.beginPath(),e.moveTo(-10,-5),e.lineTo(-t*1.4,-25),e.stroke(),e.restore(),e.save(),e.rotate(i),e.beginPath(),e.moveTo(0,0),e.lineTo(t*1.5,-30),e.lineTo(t*1.4,0),e.lineTo(t*1.5,30),e.closePath(),e.fillStyle=s.color,e.fill(),e.strokeStyle=l.PENCIL_DARK,e.lineWidth=2,e.stroke(),e.strokeStyle="#ffffff",e.lineWidth=1,e.beginPath(),e.moveTo(10,-5),e.lineTo(t*1.4,-25),e.stroke(),e.restore(),e.beginPath(),e.arc(0,0,20,0,Math.PI*2),e.fillStyle=s.accentColor,e.fill(),e.strokeStyle=l.PENCIL_DARK,e.lineWidth=3,e.stroke(),e.strokeStyle=s.accentColor,e.lineWidth=8,e.beginPath(),e.ellipse(-t*.3,t*.7,25,30,-.3,0,Math.PI*2),e.stroke(),e.beginPath(),e.ellipse(t*.3,t*.7,25,30,.3,0,Math.PI*2),e.stroke(),e.fillStyle="#ffffff",e.beginPath(),e.arc(0,-3,10,0,Math.PI*2),e.fill(),e.fillStyle="#ff0000",e.beginPath(),e.arc(0,-1,5,0,Math.PI*2),e.fill()}drawBossEyes(e,t,s,i,a,n=1){const o=10*n,r=5*n;e.fillStyle="#ffffff",e.beginPath(),e.ellipse(t,s,o,o*.8,0,0,Math.PI*2),e.fill(),e.strokeStyle=l.PENCIL_DARK,e.lineWidth=2,e.stroke();const d=this.playerX-this.boss.x,h=this.playerY-this.boss.y,u=Math.atan2(h,d);e.fillStyle="#000000",e.beginPath(),e.arc(t+Math.cos(u)*3,s+Math.sin(u)*2,r,0,Math.PI*2),e.fill(),e.fillStyle="#ffffff",e.beginPath(),e.ellipse(i,a,o,o*.8,0,0,Math.PI*2),e.fill(),e.strokeStyle=l.PENCIL_DARK,e.lineWidth=2,e.stroke(),e.fillStyle="#000000",e.beginPath(),e.arc(i+Math.cos(u)*3,a+Math.sin(u)*2,r,0,Math.PI*2),e.fill(),e.strokeStyle=l.PENCIL_DARK,e.lineWidth=3,e.beginPath(),e.moveTo(t-o,s-o),e.lineTo(t+o*.5,s-o*.5),e.stroke(),e.beginPath(),e.moveTo(i+o,a-o),e.lineTo(i-o*.5,a-o*.5),e.stroke()}drawBossHealthBar(e,t){if(!this.boss)return;const s=this.ctx,i=160,a=12,n=this.boss.health/this.boss.maxHealth;s.fillStyle="rgba(0, 0, 0, 0.3)",s.fillRect(e-i/2,t,i,a);const o=n>.5?"#44cc44":n>.25?"#cccc44":"#cc4444";s.fillStyle=o,s.fillRect(e-i/2,t,i*n,a),s.strokeStyle=l.PENCIL_DARK,s.lineWidth=2,s.strokeRect(e-i/2,t,i,a),s.fillStyle=l.PENCIL_DARK,s.font="bold 10px "+l.FONT_FAMILY,s.textAlign="center",s.fillText(this.boss.health+"/"+this.boss.maxHealth,e,t+a+12)}}window.addEventListener("DOMContentLoaded",()=>{console.log("[main] Initializing Paper Plane Asteroid Survivor"),new D});</script>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <!-- Damage Overlay -->
        <div id="damageOverlay"></div>

        <!-- Boss Announcement -->
        <div id="bossAnnouncement">
            <div class="boss-text">BOSS INCOMING</div>
        </div>

        <!-- HUD -->
        <div id="hud" class="hidden">
            <div class="hud-left">
                <div class="hud-label">Time</div>
                <div class="hud-value" id="timeDisplay">0:00</div>
            </div>
            <div class="hud-center">
                <div class="hud-lives" id="livesDisplay"></div>
                <div class="hud-shield" id="shieldDisplay"></div>
                <div class="progress-bar-container">
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0/6</div>
                </div>
            </div>
            <div class="hud-right">
                <div class="hud-label">Points</div>
                <div class="hud-value" id="coinDisplay">0</div>
            </div>
        </div>

        <!-- UI Layer -->
        <div id="uiLayer">
            <!-- Ability Slots (Stackable) -->
            <div id="abilitySlots"></div>

            <!-- Pause Button -->
            <button id="pauseBtn" class="hidden">
                <svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>

            <!-- Settings Button -->
            <button id="settingsBtn">
                <svg viewBox="0 0 24 24">
                    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                </svg>
            </button>
        </div>

        <!-- Item Inventory -->
        <div id="itemInventory" class="item-inventory hidden"></div>

        <!-- Start Screen -->
        <div id="startScreen" class="overlay">
            <div class="content">
                <h1 class="title">Paper Plane</h1>
                <p class="subtitle">Asteroid Survivor</p>

                <div class="demo-container">
                    <canvas id="demoCanvas"></canvas>
                </div>

                <div class="start-buttons">
                    <button class="btn" id="startButton">Start Flight</button>
                    <button class="btn btn-secondary" id="galleryButton">Gallery</button>
                </div>
            </div>
        </div>

        <!-- Gallery Screen -->
        <div id="galleryScreen" class="overlay hidden">
            <div class="content gallery-content">
                <h2 class="plane-select-title">Gallery</h2>

                <div class="gallery-section">
                    <h3 class="gallery-title">Planes</h3>
                    <div class="plane-selection">
                        <div class="plane-card selected" data-plane="dart">
                            <div class="plane-icon">D</div>
                            <div class="plane-name">The Dart</div>
                            <div class="plane-quirk">Precise aim, perfectly straight shots</div>
                        </div>
                        <div class="plane-card" data-plane="glider">
                            <div class="plane-icon">G</div>
                            <div class="plane-name">The Glider</div>
                            <div class="plane-quirk">Floaty movement with momentum drift</div>
                        </div>
                        <div class="plane-card" data-plane="bomber">
                            <div class="plane-icon">B</div>
                            <div class="plane-name">Dart Bomber</div>
                            <div class="plane-quirk">Twitchy controls, sketchy aim spread</div>
                        </div>
                    </div>
                </div>

                <div class="gallery-section">
                    <h3 class="gallery-title">Bosses</h3>
                    <div class="boss-gallery">
                        <div class="boss-list">
                        <div class="boss-card">
                                <div class="boss-name">1. The Eraser</div>
                                <div class="boss-desc">Pink menace! Sways side-to-side, throws tumbling eraser chunks in waves of 3.</div>
                        </div>
                            <div class="boss-card">
                                <div class="boss-name">2. Paperweight</div>
                                <div class="boss-desc">Heavy hitter! Drops heavy rocks that fall straight down in salvos of 5.</div>
                            </div>
                            <div class="boss-card">
                                <div class="boss-name">3. Ink Blot</div>
                                <div class="boss-desc">Chaotic stain! Chases you and sprays ink blobs in 3-way spreads.</div>
                            </div>
                            <div class="boss-card">
                                <div class="boss-name">4. Rubber Band Ball</div>
                                <div class="boss-desc">Bouncy nightmare! Bounces off walls firing stretchy rubber bands in spirals.</div>
                            </div>
                            <div class="boss-card">
                                <div class="boss-name">5. The Stapler</div>
                                <div class="boss-desc">Rapid fire! Zigzags while shooting 8 fast staples per wave.</div>
                            </div>
                            <div class="boss-card">
                                <div class="boss-name">6. Scissors</div>
                                <div class="boss-desc">Final cut! Circles overhead firing deadly scissor blades in V-patterns.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="gallery-section">
                    <h3 class="gallery-title">Upgrade Paths</h3>
                    <div class="modifier-gallery">
                        <div class="modifier-chip">Rapid Fire (5 Levels)</div>
                        <div class="modifier-chip">Multi-Shot (5 Levels)</div>
                        <div class="modifier-chip">Turret Buddy (5 Levels)</div>
                    </div>
                </div>

                <div class="gallery-section">
                    <h3 class="gallery-title">Ultimate Abilities</h3>
                    <div class="modifier-gallery">
                        <div class="modifier-chip">
                            <svg viewBox="0 0 24 24" class="chip-svg"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                            Paper Shield
                        </div>
                        <div class="modifier-chip">
                            <svg viewBox="0 0 24 24" class="chip-svg"><path d="M12 2 L15 9 L22 9 L16 14 L18 21 L12 17 L6 21 L8 14 L2 9 L9 9 Z" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                            Eraser Blast
                        </div>
                        <div class="modifier-chip">
                            <svg viewBox="0 0 24 24" class="chip-svg"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                            Ink Overdrive
                        </div>
                    </div>
                </div>

                <button class="btn btn-secondary" id="backFromGalleryBtn">Back</button>
            </div>
        </div>

        <!-- Upgrade Screen -->
        <div id="upgradeScreen" class="overlay hidden">
            <div class="content">
                <h2 class="upgrade-title">LEVEL UP!</h2>
                <p class="upgrade-subtitle">Choose your next upgrade</p>

                <div class="upgrade-cards-container">
                    <div class="upgrade-card" data-item-id="fireRate">
                        <div class="upgrade-card-icon">
                            <svg viewBox="0 0 40 40" class="upgrade-svg">
                                <path d="M20 8 L20 32 M14 14 L20 8 L26 14" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                                <line x1="10" y1="28" x2="30" y2="28" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <div class="upgrade-card-title">Fire Rate</div>
                        <div class="upgrade-card-level">
                            <span class="level-dots">
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                            </span>
                    </div>
                        <div class="upgrade-card-next">
                            <span class="next-label">NEXT:</span>
                            <span class="next-name">Quick Draw</span>
                            <span class="next-bonus">+15% speed</span>
                        </div>
                    </div>

                    <div class="upgrade-card" data-item-id="multiShot">
                        <div class="upgrade-card-icon">
                            <svg viewBox="0 0 40 40" class="upgrade-svg">
                                <line x1="12" y1="10" x2="12" y2="30" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                                <line x1="20" y1="10" x2="20" y2="30" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                                <line x1="28" y1="10" x2="28" y2="30" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <div class="upgrade-card-title">Multi-Shot</div>
                        <div class="upgrade-card-level">
                            <span class="level-dots">
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                            </span>
                    </div>
                        <div class="upgrade-card-next">
                            <span class="next-label">NEXT:</span>
                            <span class="next-name">Double Tap</span>
                            <span class="next-bonus">2 bullets</span>
                        </div>
                    </div>

                    <div class="upgrade-card" data-item-id="turrets">
                        <div class="upgrade-card-icon">
                            <svg viewBox="0 0 40 40" class="upgrade-svg">
                                <rect x="14" y="18" width="12" height="14" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                                <line x1="20" y1="8" x2="20" y2="18" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                                <circle cx="20" cy="25" r="3" fill="currentColor"/>
                            </svg>
                        </div>
                        <div class="upgrade-card-title">Turret Buddy</div>
                        <div class="upgrade-card-level">
                            <span class="level-dots">
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                            </span>
                        </div>
                        <div class="upgrade-card-next">
                            <span class="next-label">NEXT:</span>
                            <span class="next-name">Helper I</span>
                            <span class="next-bonus">+1 turret</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ability Selection Screen -->
        <div id="abilityScreen" class="overlay hidden">
            <div class="content">
                <h2 class="ability-title">BOSS DEFEATED!</h2>
                <p class="ability-subtitle">Choose your Ultimate Ability</p>

                <div class="ability-cards-container">
                    <div class="ability-card" data-ability-id="invincibility">
                        <div class="ability-card-icon">
                            <svg viewBox="0 0 24 24" class="ability-svg"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                        <div class="ability-card-title">Paper Shield</div>
                        <div class="ability-card-desc">Become invincible for 5 seconds</div>
                        <div class="ability-card-charges">1 USE</div>
                    </div>

                    <div class="ability-card" data-ability-id="destruction">
                        <div class="ability-card-icon">
                            <svg viewBox="0 0 24 24" class="ability-svg"><path d="M12 2 L15 9 L22 9 L16 14 L18 21 L12 17 L6 21 L8 14 L2 9 L9 9 Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                        <div class="ability-card-title">Eraser Blast</div>
                        <div class="ability-card-desc">Destroy all asteroids on screen</div>
                        <div class="ability-card-charges">1 USE</div>
                    </div>

                    <div class="ability-card" data-ability-id="turbo">
                        <div class="ability-card-icon">
                            <svg viewBox="0 0 24 24" class="ability-svg"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                        <div class="ability-card-title">Ink Overdrive</div>
                        <div class="ability-card-desc">Double fire rate & speed for 8s</div>
                        <div class="ability-card-charges">1 USE</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pause Screen -->
        <div id="pauseScreen" class="overlay hidden">
            <div class="content">
                <h2 class="pause-title">Paused</h2>
                <div class="pause-buttons">
                    <button class="btn" id="resumeButton">Resume</button>
                    <button class="btn btn-secondary" id="pauseRestartBtn">Restart</button>
                    <button class="btn btn-secondary" id="pauseMenuBtn">Menu</button>
                </div>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="gameOverScreen" class="overlay hidden">
            <div class="content">
                <h2 class="game-over-title">Flight Ended</h2>

                <div class="final-stats">
                    <div class="stat-row">
                        <span class="stat-label">Survival Time</span>
                        <span class="stat-value" id="finalTime">0:00</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Points Earned</span>
                        <span class="stat-value" id="finalCoins">0</span>
                    </div>
                    <div class="upgrade-summary">
                        <div class="summary-item">
                            <div class="summary-value" id="summaryItems">0</div>
                            <div class="summary-label">Upgrades</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="summaryCursed">0</div>
                            <div class="summary-label">Bosses</div>
                        </div>
                    </div>
                </div>

                <div class="game-over-buttons">
                    <button class="btn" id="restartButton">Fly Again</button>
                    <button class="btn btn-secondary" id="menuButton">Menu</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="hidden">
            <h3 class="settings-title">Settings</h3>
            <div class="settings-row">
                <span class="settings-label">Music</span>
                <div class="toggle active" id="musicToggle"></div>
            </div>
            <div class="settings-row">
                <span class="settings-label">Sound FX</span>
                <div class="toggle active" id="fxToggle"></div>
            </div>
            <div class="settings-row">
                <span class="settings-label">Haptics</span>
                <div class="toggle active" id="hapticToggle"></div>
            </div>
            <button class="btn settings-close" id="settingsClose">Done</button>
        </div>
    </div>

</body>
</html>
