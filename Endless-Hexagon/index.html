<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/style.css">
    <title>Phaser - Template</title>
</head>

<body>
    <div id="app" class="relative w-full h-full bg-slate-900">
        <div id="game-container" class="w-full h-full"></div>

        <!-- Main Menu -->
        <div id="main-menu"
            class="absolute inset-0 z-50 flex flex-col items-center justify-center transition-opacity duration-700">
            <!-- Title -->
            <div class="mb-24 -mt-24 text-center animate-float">
                <h1
                    class="font-display text-5xl md:text-7xl text-white tracking-widest drop-shadow-[5px_5px_0_rgba(0,0,0,1)] mb-4 glitch-text">
                    ENDLESS<br>HEXAGON
                </h1>
                <p
                    class="font-display text-xs md:text-sm text-white tracking-[0.5em] animate-pulse drop-shadow-[2px_2px_0_rgba(0,0,0,1)] stroke-black">
                    PRESS PLAY TO START
                </p>
            </div>

            <!-- Play Button -->
            <button id="play-btn"
                class="group relative px-16 py-6 bg-yellow-400 hover:bg-yellow-300 text-slate-900 font-display text-2xl transition-all hover:-translate-y-1 hover:shadow-[0_10px_0_rgba(0,0,0,0.5)] active:translate-y-1 active:shadow-none pixel-btn">
                <span class="relative z-10">PLAY</span>
                <!-- Pixel Corners -->
                <div class="absolute inset-0 border-4 border-black group-hover:border-slate-800"></div>
            </button>


        </div>

        <!-- Settings Button (Gear) -->
        <button id="settings-btn"
            class="absolute settings-pos right-5 z-50 w-12 h-12 bg-slate-800 text-white flex items-center justify-center pixel-border-sm hover:bg-slate-700 transition-colors">
            <span class="material-icons">settings</span>
        </button>

        <!-- Game Over Modal -->
        <div id="game-over-modal" class="absolute inset-0 z-40 bg-black/80 flex items-center justify-center hidden">
            <div class="w-full max-w-md bg-slate-200 dark:bg-slate-800 p-8 pixel-card shadow-2xl relative">
                <div class="mb-8 text-center">
                    <h1 class="font-display text-4xl text-red-500 mb-2">GAME OVER</h1>
                    <div class="h-2 w-full bg-white mx-auto"></div>
                </div>

                <div class="text-center mb-8">
                    <p class="text-slate-600 dark:text-slate-400 text-sm mb-2">FINAL SCORE</p>
                    <p id="final-score" class="font-display text-5xl text-slate-800 dark:text-slate-100 mb-4">0</p>
                </div>

                <div class="space-y-4">
                    <button id="restart-btn"
                        class="w-full p-4 bg-white text-slate-900 font-bold pixel-border-sm hover:translate-y-[-2px] hover:shadow-lg transition-all active:translate-y-1">
                        RESTART
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Modal (Retro Style) -->
        <div id="settings-modal" class="absolute inset-0 z-50 bg-black/80 flex items-center justify-center hidden">
            <div class="w-full max-w-md bg-slate-200 dark:bg-slate-800 p-8 pixel-card shadow-2xl">
                <div class="mb-10 text-center">
                    <h2 class="font-display text-2xl text-slate-800 dark:text-slate-100 mb-2">SETTINGS</h2>
                    <div class="h-2 w-32 bg-white mx-auto"></div>
                </div>

                <div class="space-y-6">
                    <!-- Music -->
                    <div class="flex items-center justify-between p-4 bg-slate-300 dark:bg-slate-700 pixel-border-sm">
                        <div class="flex items-center gap-4">
                            <span class="material-icons text-slate-600 dark:text-slate-300">music_note</span>
                            <span class="font-bold text-slate-700 dark:text-slate-200">MUSIC</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="music-toggle" checked>
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <!-- FX -->
                    <div class="flex items-center justify-between p-4 bg-slate-300 dark:bg-slate-700 pixel-border-sm">
                        <div class="flex items-center gap-4">
                            <span class="material-icons text-slate-600 dark:text-slate-300">volume_up</span>
                            <span class="font-bold text-slate-700 dark:text-slate-200">SOUND FX</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="fx-toggle" checked>
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <!-- Haptics -->
                    <div class="flex items-center justify-between p-4 bg-slate-300 dark:bg-slate-700 pixel-border-sm">
                        <div class="flex items-center gap-4">
                            <span class="material-icons text-slate-600 dark:text-slate-300">vibration</span>
                            <span class="font-bold text-slate-700 dark:text-slate-200">HAPTICS</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="haptics-toggle" checked>
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>

                <div class="mt-8">
                    <button id="close-settings"
                        class="w-full p-3 bg-slate-600 text-white pixel-border-sm hover:bg-slate-500 transition-colors">
                        CLOSE
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Tailwind & Fonts -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#fbbf24",
                        "background-light": "#cbd5e1",
                        "background-dark": "#1e293b",
                    },
                    fontFamily: {
                        display: ["'Press Start 2P'", "cursive"],
                    },
                },
            },
        };
    </script>

    <!-- Game & UI Logic -->
    <script>
        // Platform State (legacy - game now uses its own settings system)
        // Kept for backward compatibility with some UI code
        window.platform = {
            musicEnabled: true,
            fxEnabled: true,
            hapticsEnabled: true,
        };

        // Elements
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings');
        const gameOverModal = document.getElementById('game-over-modal');
        const finalScoreEl = document.getElementById('final-score');
        const restartBtn = document.getElementById('restart-btn');
        // Settings button removed from game over modal

        const mainMenu = document.getElementById('main-menu');
        const playBtn = document.getElementById('play-btn');

        const musicToggle = document.getElementById('music-toggle');
        const fxToggle = document.getElementById('fx-toggle');
        const hapticsToggle = document.getElementById('haptics-toggle');

        function updateToggles() {
            // Use game settings if available, otherwise use platform defaults
            if (window.getSettings) {
                const settings = window.getSettings();
                musicToggle.checked = settings.music;
                fxToggle.checked = settings.fx;
                hapticsToggle.checked = settings.haptics;
            } else {
                musicToggle.checked = window.platform.musicEnabled;
                fxToggle.checked = window.platform.fxEnabled;
                hapticsToggle.checked = window.platform.hapticsEnabled;
            }
        }
        // Delay initial update until game might be ready
        setTimeout(updateToggles, 100);

        // Event Listeners
        function openSettings() {
            // Sync toggles with game's current settings
            if (window.getSettings) {
                const settings = window.getSettings();
                musicToggle.checked = settings.music;
                fxToggle.checked = settings.fx;
                hapticsToggle.checked = settings.haptics;
            }
            settingsModal.classList.remove('hidden');
            if (window.triggerHaptic) window.triggerHaptic('light');
            if (window.pauseGame) window.pauseGame();
        }
        function closeSettings() {
            settingsModal.classList.add('hidden');
            if (window.triggerHaptic) window.triggerHaptic('light');
            if (window.resumeGame) window.resumeGame();
        }

        settingsBtn.onclick = openSettings;
        closeSettingsBtn.onclick = closeSettings;

        restartBtn.onclick = () => {
            if (window.triggerHaptic) window.triggerHaptic('medium');
            // Set restart flag to prevent race conditions with showGameOver
            isRestarting = true;
            // Hide game over modal and call startGame directly (like Car Balance)
            gameOverModal.classList.add('hidden');
            if (window.startGame) {
                window.startGame();
            } else {
                isRestarting = false;
                mainMenu.classList.remove('opacity-0', 'pointer-events-none');
            }
        };

        // Main Menu Logic
        // Main Menu Logic
        const playBtnText = playBtn.querySelector('span'); // Get text span

        // Disable Button Initially
        playBtn.disabled = true;
        playBtn.classList.add('opacity-50', 'cursor-wait');
        playBtn.classList.remove('hover:bg-yellow-300', 'hover:-translate-y-1');
        if (playBtnText) playBtnText.textContent = "LOADING...";

        // Game Ready Hook (Called from Scene.ts)
        window.onGameReady = () => {
            playBtn.disabled = false;
            playBtn.classList.remove('opacity-50', 'cursor-wait');
            playBtn.classList.add('hover:bg-yellow-300', 'hover:-translate-y-1');
            if (playBtnText) playBtnText.textContent = "PLAY";
        };

        playBtn.onclick = () => {
            if (window.triggerHaptic) window.triggerHaptic('medium');

            // Start Game IMMEDIATELY
            if (window.startGame) window.startGame();

            // Fade out visuals
            mainMenu.classList.add('opacity-0', 'pointer-events-none');
        };

        // Expose Show Menu
        window.showMainMenu = () => {
            mainMenu.classList.remove('opacity-0', 'pointer-events-none');
            gameOverModal.classList.add('hidden');
        };

        // Toggles - Call the game's settings API
        musicToggle.onchange = (e) => {
            if (window.setMusic) window.setMusic(e.target.checked);
        };
        fxToggle.onchange = (e) => {
            if (window.setFx) window.setFx(e.target.checked);
        };
        hapticsToggle.onchange = (e) => {
            if (window.setHaptics) window.setHaptics(e.target.checked);
        };

        // Oasiz / Global Hooks
        // Per AGENTS.md: Platform handles leaderboards, games just call submitScore
        let isRestarting = false; // Guard flag to prevent modal showing during restart
        
        window.showGameOver = (score) => {
            // Don't show modal if we're in the middle of restarting
            if (isRestarting) {
                console.log("[showGameOver] Blocked - restart in progress");
                return;
            }
            finalScoreEl.textContent = score;
            gameOverModal.classList.remove('hidden');
        };
        
        // Called by Scene.ts when game actually starts (clears restart flag)
        window.onGameStarted = () => {
            isRestarting = false;
        };

        // DO NOT define window.submitScore - the platform injects the real one!
        // Only define a fallback for local web testing if platform hasn't injected
        if (typeof window.submitScore !== 'function') {
            window.submitScore = (score) => {
                console.log("[Fallback] submitScore called with:", score, "(platform not injected)");
            };
        }

        // Only define triggerHaptic if platform didn't inject one (for local web testing)
        // On mobile, the platform injects the real native haptic function
        if (typeof window.triggerHaptic !== 'function') {
            window.triggerHaptic = (type) => {
                // Web fallback using Vibration API (not supported on iOS)
                if (navigator.vibrate) {
                    navigator.vibrate(type === 'heavy' ? 50 : type === 'medium' ? 20 : 10);
                }
            };
        }

        // --- UI Sounds ---
        const clickSound = new Audio('/audio/ButtonClick.wav');
        function playClick() {
            // Use game settings if available, otherwise use platform defaults
            const settings = window.getSettings ? window.getSettings() : window.platform;
            if (settings && (settings.fx || settings.fxEnabled)) {
                clickSound.currentTime = 0;
                clickSound.play().catch(() => { });
            }
        }
        // Attach to controls
        document.querySelectorAll('button').forEach(btn => btn.addEventListener('click', playClick));
        document.querySelectorAll('input[type="checkbox"]').forEach(inp => inp.addEventListener('change', playClick));

    </script>
    <script type="module" src="/src/main.ts"></script>
    <style>
        .pixel-border {
            box-shadow: 0 -4px 0 0 #000, 0 4px 0 0 #000, -4px 0 0 0 #000, 4px 0 0 0 #000;
        }

        .pixel-border-sm {
            box-shadow: 0 -2px 0 0 #000, 0 2px 0 0 #000, -2px 0 0 0 #000, 2px 0 0 0 #000;
        }

        .pixel-card {
            border: 4px solid #475569;
            position: relative;
        }

        .pixel-card::after {
            content: '';
            position: absolute;
            inset: -4px;
            border: 4px solid #000;
            pointer-events: none;
        }

        /* Toggle Switch Custom */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #ffffff;
        }

        /* Primary Color */
        input:checked+.slider:before {
            transform: translateX(22px);
            background-color: #333;
        }

        /* Animations */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .animate-float {
            animation: float 4s ease-in-out infinite;
        }

        .pixel-btn {
            box-shadow: 0 6px 0 0 #000;
        }

        .stroke-black {
            -webkit-text-stroke: 1px black;
        }

        /* Settings Alignment - Safe Area (per AGENTS.md) */
        .settings-pos {
            top: 45px;
        }

        @media (pointer: coarse) {
            .settings-pos {
                top: 120px;
            }
        }
    </style>
</body>

</html>